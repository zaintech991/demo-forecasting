<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Dimensional Forecasting Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23667eea%22/><text x=%2250%22 y=%2265%22 font-family=%22Arial%22 font-size=%2260%22 fill=%22white%22 text-anchor=%22middle%22>ðŸ“Š</text></svg>">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Chart.js Plugins for advanced interactivity -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@3.0.0/dist/chartjs-plugin-crosshair.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
    
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .selection-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .multi-select {
            border-radius: 12px;
            border: 2px solid #e0e6ed;
            box-shadow: 0 2px 8px rgba(102,126,234,0.04);
            font-size: 1.05rem;
            transition: border-color 0.2s;
        }
        .form-select:focus, .multi-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px #667eea33;
        }
        .multi-select {
            background: #f8f9fa;
            padding: 1rem;
        }
        .selected-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin: 0.25rem;
            display: inline-block;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .selected-item .remove-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            margin-left: 0.5rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            line-height: 1;
            padding: 0;
        }
        .form-select option[disabled] {
            color: #aaa;
        }
        .dropdown-search {
            width: 100%;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid #e0e6ed;
            padding: 0.4rem 0.7rem;
        }
        
        .forecast-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .forecast-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .demand-forecast-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
            transition: all 0.3s ease;
        }
        
        .demand-forecast-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
        }
        
        .results-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        
        .insight-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .insight-card h5 {
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .insight-card .insight-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .insight-card .metrics {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        .insight-card .metric {
            text-align: center;
        }
        
        .insight-card .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .insight-card .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .demand-insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .demand-insight-card.critical {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        
        .demand-insight-card.high {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
        }
        
        .demand-insight-card.medium {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        }
        
        .demand-insight-card.low {
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
        }
        
        .stockout-risk-gauge {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        
        .inventory-status-card {
            border-radius: 15px;
            background: #fff;
            padding: 1.5rem 1.2rem 1.2rem 1.2rem;
            margin-bottom: 0.5rem;
            border-left: 6px solid #e3f0fc;
            min-height: 260px;
            transition: box-shadow 0.2s, border-color 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .inventory-status-card.critical { border-left-color: #ff6b6b; box-shadow: 0 2px 12px rgba(255,107,107,0.08); }
        .inventory-status-card.high { border-left-color: #ffb74d; box-shadow: 0 2px 12px rgba(255,183,77,0.08); }
        .inventory-status-card.medium { border-left-color: #26c6da; box-shadow: 0 2px 12px rgba(38,198,218,0.08); }
        .inventory-status-card.low { border-left-color: #43a047; box-shadow: 0 2px 12px rgba(67,160,71,0.08); }
        .inventory-status-card:hover { box-shadow: 0 4px 24px rgba(38,98,218,0.13); border-left-width: 8px; }
        .inventory-status-card .mini-trend { font-size: 1.1rem; color: #bdbdbd; margin-top: 0.5rem; }
        
        .location-info {
            margin-bottom: 1rem;
        }
        
        .location-info .badge {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
        }
        
        .location-info .badge.bg-secondary {
            background-color: #6c757d !important;
        }
        
        .location-info .badge.bg-info {
            background-color: #0dcaf0 !important;
        }
        
        .weather-controls-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #17a2b8;
        }
        
        .weather-section-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #28a745;
            height: 100%;
        }
        
        .weather-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .weather-recommendation-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .weather-recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .weather-recommendation-card.increase-stock {
            border-left-color: #28a745;
        }
        
        .weather-recommendation-card.decrease-stock {
            border-left-color: #dc3545;
        }
        
        .weather-recommendation-card.bundle-opportunity {
            border-left-color: #ffc107;
        }
        
        .promotional-analysis-card {
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .promotional-analysis-card.highly-recommended {
            border-left: 4px solid #28a745;
            background: linear-gradient(90deg, #e6f9ed 0%, #fff 100%);
        }
        
        .promotional-analysis-card.recommended {
            border-left: 4px solid #17a2b8;
            background: linear-gradient(90deg, #e0faff 0%, #fff 100%);
        }
        
        .promotional-analysis-card.moderate {
            border-left: 4px solid #ffc107;
            background: linear-gradient(90deg, #fffbe6 0%, #fff 100%);
        }
        
        .promotional-analysis-card.not-recommended {
            border-left: 4px solid #dc3545;
            background: linear-gradient(90deg, #ffeaea 0%, #fff 100%);
        }
        
        .bundle-recommendation-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .seasonal-insight-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .weather-metric {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 0.5rem;
        }
        
        .weather-metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }
        
        .weather-metric-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }
        
        .weather-alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }
        
        .weather-alert.alert-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .weather-alert.alert-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .weather-alert.alert-danger {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .weather-alert.alert-info {
            background: #cce7f0;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .recommendation-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .recommendation-card.critical {
            background: linear-gradient(135deg, #ffcccb 0%, #ffb3ba 100%);
        }
        
        .recommendation-card.high {
            background: linear-gradient(135deg, #ffd1a9 0%, #ffcc95 100%);
        }
        
        .comparison-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .comparison-card h6 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }
        
        /* Product Sales Chart Styles */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        #productFilterControls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #e0e6ed;
        }
        
        #productFilterControls .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        #productFilterControls .form-select {
            border-radius: 8px;
            border: 2px solid #e0e6ed;
            transition: border-color 0.2s;
        }
        
        #productFilterControls .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px #667eea33;
        }
        
        .btn-group .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-group .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        
        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .summary-stats {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .summary-stats h4 {
            color: #333;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .summary-stats .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .summary-stats .stat-item {
            text-align: center;
        }
        
        .summary-stats .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .summary-stats .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #667eea;
        }
        
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 600;
            border: none;
            border-radius: 10px 10px 0 0;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .tab-content {
            padding: 2rem 0;
        }

        .insight-notification { border-left: 6px solid #667eea; background: #f8f9fa; }
        .notification-success { border-color: #28a745 !important; background: #eafaf1 !important; }
        .notification-danger { border-color: #dc3545 !important; background: #fbeaea !important; }
        .notification-warning { border-color: #ffc107 !important; background: #fffbe6 !important; }
        .notification-info { border-color: #17a2b8 !important; background: #eaf6fb !important; }
        .notification-icon { color: #667eea; }
        .notification-success .notification-icon { color: #28a745; }
        .notification-danger .notification-icon { color: #dc3545; }
        .notification-warning .notification-icon { color: #ffc107; }
        .notification-info .notification-icon { color: #17a2b8; }
        .metric-label { color: #888; font-size: 0.95em; }

        .comparison-card canvas { max-height: 220px; margin-bottom: 1rem; }

        .stat-card {
            border-radius: 15px;
            padding: 1.5rem 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            margin-bottom: 1rem;
            text-align: center;
            position: relative;
            background: #f8fafd;
        }
        .stat-card-lightblue { background: #e3f0fc !important; color: #2563eb !important; }
        .stat-card-lightred { background: #ffeaea !important; color: #d32f2f !important; }
        .stat-card-lightorange { background: #fff5e6 !important; color: #ff9800 !important; }
        .stat-card-lightteal { background: #e0f7fa !important; color: #00838f !important; }
        .stat-card-lightgreen { background: #e6f9ed !important; color: #388e3c !important; }
        .stat-icon { font-size: 2.2rem; margin-bottom: 0.5rem; display: block; }
        .card.h-100 { background: linear-gradient(135deg, #f8fafd 60%, #e3f0fc 100%); border: 1px solid #e3f0fc; box-shadow: 0 2px 10px rgba(0,0,0,0.07); }
        .doughnut-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .doughnut-legend .legend-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.98rem;
            background: #fff;
            border-radius: 20px;
            padding: 0.25rem 0.9rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            border: 1px solid #eee;
            transition: box-shadow 0.2s, border-color 0.2s;
            cursor: pointer;
            outline: none;
            margin-right: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .doughnut-legend .legend-pill:focus, .doughnut-legend .legend-pill:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            border-color: #2563eb;
        }
        .doughnut-legend .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid #eee;
        }
        .card.h-100 { max-height: 340px; }
        #stockoutRiskChart {
            height: 100% !important;
            width: 100% !important;
            aspect-ratio: 1 / 1;
            display: block;
            margin: 0 auto;
            max-height: none;
        }
        .card.h-100.p-3.shadow-sm {
            min-height: 100%;
            max-height: none;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .animated-bar-container {
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
            overflow: hidden;
        }
        .animated-bar-bg {
            width: 70%;
            height: 14px;
            background: #f1f3f6;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        .animated-bar-fill {
            height: 100%;
            border-radius: 7px;
            transition: width 1.2s cubic-bezier(0.4,0,0.2,1);
            min-width: 5%;
        }
        .animated-bar-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: #444;
            margin-left: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 38%;
            display: inline-block;
        }
        .status-ok-badge {
            min-width: 38px;
            text-align: right;
            margin-left: 0.5rem;
            padding: 0.15rem 0.5rem;
            border-radius: 8px;
            background: #f8fafd;
            font-weight: 500;
            font-size: 0.98rem;
            position: relative;
            z-index: 1;
        }
        .stockout-risk-badge {
            top: 12px;
            right: 16px;
            z-index: 2;
            position: absolute !important;
            pointer-events: none;
            padding: 0;
        }
        .inventory-status-card {
            padding-top: 1.7rem;
            padding-bottom: 1.2rem;
        }
        .inventory-status-card .badge.bg-light.text-dark {
            font-size: 1.01rem;
            padding: 0.32em 0.8em;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            border: 1px solid #eee;
        }
        .stockout-risk-badge-row {
            min-height: 2.2rem;
            margin-bottom: 0.2rem;
            margin-top: 0.1rem;
        }
        .stockout-risk-badge-center {
            font-size: 1.01rem;
            padding: 0.32em 0.8em;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            border: 1px solid #eee;
            background: #f8fafd !important;
            color: #333 !important;
            position: relative;
            z-index: 2;
        }
        .status-ok-badge {
            min-width: 38px;
            text-align: right;
            margin-left: 0.5rem;
            padding: 0.15rem 0.5rem;
            border-radius: 8px;
            background: #f8fafd;
            font-weight: 500;
            font-size: 0.98rem;
            position: relative;
            z-index: 1;
        }
        .inventory-status-card {
            padding-top: 2.2rem;
            padding-bottom: 1.2rem;
        }

        .demand-alert-notification {
            border-radius: 16px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.10);
            margin-bottom: 1.2rem;
            padding: 1.3rem 1.5rem 1.1rem 1.5rem;
            background: #fff;
            border-left: 7px solid #667eea;
            position: relative;
            opacity: 0;
            transform: translateY(30px) scale(0.98);
            transition: all 0.45s cubic-bezier(.4,1.4,.6,1), opacity 0.3s;
            display: flex;
            flex-direction: column;
            animation: none;
            z-index: 1;
        }
        .demand-alert-notification.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .demand-alert-notification.animate-in {
            animation: demandAlertIn 0.7s cubic-bezier(.4,1.4,.6,1) both;
        }
        .demand-alert-notification.animate-out {
            animation: demandAlertOut 0.4s cubic-bezier(.4,1.4,.6,1) both;
        }
        @keyframes demandAlertIn {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes demandAlertOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-20px) scale(0.96); }
        }
        .demand-alert-notification.critical { border-left-color: #ff6b6b; background: linear-gradient(90deg, #ffeaea 0%, #fff 100%); }
        .demand-alert-notification.high { border-left-color: #ffb74d; background: linear-gradient(90deg, #fff5e6 0%, #fff 100%); }
        .demand-alert-notification.medium { border-left-color: #26c6da; background: linear-gradient(90deg, #e0f7fa 0%, #fff 100%); }
        .demand-alert-notification.low { border-left-color: #43a047; background: linear-gradient(90deg, #e6f9ed 0%, #fff 100%); }
        .demand-alert-notification .notification-icon { font-size: 1.5rem; }
        .demand-alert-notification .alert-recommendation { font-size: 1.08rem; font-weight: 500; color: #333; margin-bottom: 0.2rem; }
        .demand-alert-notification .btn-close { position: relative; top: 0; right: 0; z-index: 2; }
        .demand-alert-notification .badge { font-size: 0.98rem; padding: 0.4em 0.9em; border-radius: 12px; }
        .demand-alert-notification .alert-timestamp { font-size: 0.93rem; margin-top: 0.2rem; }

        .recommendation-alert-card {
            border-radius: 16px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.10);
            margin-bottom: 1.2rem;
            padding: 1.3rem 1.5rem 1.1rem 1.5rem;
            background: #fff;
            border-left: 7px solid #667eea;
            position: relative;
            opacity: 0;
            transform: translateY(30px) scale(0.98);
            transition: all 0.45s cubic-bezier(.4,1.4,.6,1), opacity 0.3s;
            display: flex;
            flex-direction: column;
            animation: none;
            z-index: 1;
        }
        .recommendation-alert-card.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .recommendation-alert-card.animate-in {
            animation: demandAlertIn 0.7s cubic-bezier(.4,1.4,.6,1) both;
        }
        .recommendation-alert-card.animate-out {
            animation: demandAlertOut 0.4s cubic-bezier(.4,1.4,.6,1) both;
        }
        .recommendation-alert-card.critical { border-left-color: #ff6b6b; background: linear-gradient(90deg, #ffeaea 0%, #fff 100%); }
        .recommendation-alert-card.high { border-left-color: #ffb74d; background: linear-gradient(90deg, #fff5e6 0%, #fff 100%); }
        .recommendation-alert-card.medium { border-left-color: #26c6da; background: linear-gradient(90deg, #e0f7fa 0%, #fff 100%); }
        .recommendation-alert-card.low { border-left-color: #43a047; background: linear-gradient(90deg, #e6f9ed 0%, #fff 100%); }
        .recommendation-alert-card .notification-icon { font-size: 1.5rem; }
        .recommendation-alert-card .impact-bar-bg { width: 100px; height: 10px; background: #f1f3f6; border-radius: 5px; overflow: hidden; position: relative; }
        .recommendation-alert-card .impact-bar-fill { height: 100%; border-radius: 5px; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); }
        .recommendation-alert-card .impact-label { font-size: 0.97rem; color: #444; margin-left: 0.5rem; white-space: nowrap; }
        .recommendation-alert-card .btn-close { position: relative; top: 0; right: 0; z-index: 2; }
        .recommendation-alert-card .badge { font-size: 0.98rem; padding: 0.4em 0.9em; border-radius: 12px; }
        .recommendation-alert-card .action-item-tooltip { cursor: pointer; text-decoration: underline dotted #bbb; }
        .recommendation-alert-card .action-item-tooltip:hover { color: #2563eb; background: #f1f3f6; }

        .promo-alert-card {
            border-radius: 16px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.10);
            margin-bottom: 1.2rem;
            padding: 1.3rem 1.5rem 1.1rem 1.5rem;
            background: #f8fafc; /* Softer base background */
            border-left: 7px solid #e0e7ef; /* Softer default border */
            position: relative;
            opacity: 0;
            transform: translateY(30px) scale(0.98);
            transition: all 0.45s cubic-bezier(.4,1.4,.6,1), opacity 0.3s;
            display: flex;
            flex-direction: column;
            animation: none;
            z-index: 1;
        }
        .promo-alert-card.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .promo-alert-card.animate-in {
            animation: demandAlertIn 0.7s cubic-bezier(.4,1.4,.6,1) both;
        }
        .promo-alert-card.animate-out {
            animation: demandAlertOut 0.4s cubic-bezier(.4,1.4,.6,1) both;
        }
        .promo-alert-card.critical { border-left-color: #ff6b6b; background: linear-gradient(90deg, #ffeaea 0%, #fff 100%); }
        .promo-alert-card.high { border-left-color: #ffb74d; background: linear-gradient(90deg, #fff5e6 0%, #fff 100%); }
        .promo-alert-card.medium { border-left-color: #26c6da; background: linear-gradient(90deg, #e0f7fa 0%, #fff 100%); }
        .promo-alert-card.low { border-left-color: #43a047; background: linear-gradient(90deg, #e6f9ed 0%, #fff 100%); }
        .promo-alert-card .notification-icon { font-size: 1.5rem; }
        .promo-alert-card .impact-bar-bg { width: 100px; height: 10px; background: #f1f3f6; border-radius: 5px; overflow: hidden; position: relative; }
        .promo-alert-card .impact-bar-fill { height: 100%; border-radius: 5px; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); }
        .promo-alert-card .impact-label { font-size: 0.97rem; color: #444; margin-left: 0.5rem; white-space: nowrap; }
        .promo-alert-card .btn-close { position: relative; top: 0; right: 0; z-index: 2; }
        .promo-alert-card .badge { font-size: 0.98rem; padding: 0.4em 0.9em; border-radius: 12px; }
        .promo-alert-card .alert-reasoning { font-size: 1.08rem; font-weight: 500; color: #333; margin-bottom: 0.2rem; }

        .weather-summary-card-advanced {
            background: linear-gradient(135deg, #e3f0fc 60%, #f8fafd 100%);
            border-radius: 18px;
            padding: 2.2rem 1.2rem 1.2rem 1.2rem;
            margin-bottom: 2rem;
            box-shadow: 0 6px 24px rgba(102,126,234,0.08);
            animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.6,1) both;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .stat-advanced-card {
            border-radius: 15px;
            padding: 1.2rem 1rem 1rem 1rem;
            background: #fff;
            min-height: 140px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: box-shadow 0.2s, border-color 0.2s;
            cursor: pointer;
            color: #1a237e;
        }
        .stat-advanced-card:hover {
            box-shadow: 0 6px 24px rgba(38,98,218,0.13);
            border-left: 6px solid #2563eb;
        }
        .stat-icon-advanced {
            font-size: 2.2rem;
            margin-bottom: 0.3rem;
            color: #1a237e;
        }
        .gradient-blue { background: linear-gradient(135deg, #e3f0fc 0%, #b6cfff 100%) !important; }
        .gradient-purple { background: linear-gradient(135deg, #d1c4e9 0%, #b3c6f7 100%) !important; }
        .gradient-orange { background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%) !important; }
        .gradient-green { background: linear-gradient(135deg, #e6f9ed 0%, #b9f6ca 100%) !important; }
        .stat-value-advanced {
            font-size: 2.1rem;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 0.2rem;
            transition: color 0.3s;
        }
        .stat-label-advanced {
            font-size: 1.01rem;
            color: #333;
            margin-bottom: 0.1rem;
            font-weight: 500;
        }

        .weather-advanced-card {
            border-radius: 15px;
            padding: 1.3rem 1.2rem 1.1rem 1.2rem;
            background: #fff;
            min-height: 120px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s, border-color 0.2s;
            animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.6,1) both;
        }
        .weather-advanced-card:hover {
            box-shadow: 0 6px 24px rgba(38,98,218,0.13);
            border-left: 6px solid #2563eb;
        }
        .weather-advanced-icon {
            font-size: 1.7rem;
            color: #2563eb;
        }
        .gradient-blue { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%) !important; }
        .gradient-purple { background: linear-gradient(135deg, #d1c4e9 0%, #b3c6f7 100%) !important; }
        .gradient-orange { background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%) !important; }
        .gradient-green { background: linear-gradient(135deg, #e6f9ed 0%, #b9f6ca 100%) !important; }
        .impact-bar-bg { width: 100px; height: 10px; background: #f1f3f6; border-radius: 5px; overflow: hidden; position: relative; }
        .impact-bar-fill { height: 100%; border-radius: 5px; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); }
        .impact-label { font-size: 0.97rem; color: #444; margin-left: 0.5rem; white-space: nowrap; }

        .inventory-overview-advanced.animate-in { animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.6,1) both; }
        .gradient-red { background: linear-gradient(135deg, #ffeaea 0%, #ff8a8a 100%) !important; }
        .gradient-teal { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%) !important; }

        .forecast-summary-advanced.animate-in { animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.6,1) both; }
        .gradient-purple { background: linear-gradient(135deg, #d1c4e9 0%, #b3c6f7 100%) !important; }

        .stat-advanced-card.gradient-purple { background: linear-gradient(135deg, #d1c4e9 0%, #b3c6f7 100%) !important; }
        .stat-advanced-card.gradient-green { background: linear-gradient(135deg, #e6f9ed 0%, #81c784 100%) !important; }
        .stat-advanced-card.gradient-blue { background: linear-gradient(135deg, #e3f0fc 0%, #b6cfff 100%) !important; }
        .stat-advanced-card.gradient-orange { background: linear-gradient(135deg, #fff3e0 0%, #ffd180 100%) !important; }
        .cluster-badge.animate-in { animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.6,1) both; margin: 0.2rem 0.4rem 0.2rem 0; padding: 0.5rem 1.1rem; border-radius: 16px; color: #fff; font-weight: 600; font-size: 1.01rem; display: inline-block; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .clustering-quality-advanced.animate-in { animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.6,1) both; }

        /* --- Advanced Clustering UI Styles --- */
        .stat-advanced-card {
            border-radius: 1.1rem;
            box-shadow: 0 2px 12px 0 rgba(60,60,100,0.08), 0 1.5px 4px 0 rgba(60,60,100,0.06);
            padding: 1.2rem 1.3rem 1.1rem 1.3rem;
            background: #f8fafc;
            transition: box-shadow 0.3s, transform 0.3s;
            border: none;
            position: relative;
            overflow: hidden;
            min-height: 110px;
        }
        .stat-advanced-card:hover {
            box-shadow: 0 6px 24px 0 rgba(60,60,100,0.13), 0 2.5px 8px 0 rgba(60,60,100,0.10);
            transform: translateY(-2px) scale(1.02);
        }
        .stat-advanced-card .stat-label {
            color: #6c757d;
            font-weight: 500;
            letter-spacing: 0.03em;
        }
        .stat-advanced-card .stat-value {
            font-size: 2.1rem;
            font-weight: 700;
            color: #22223b;
            letter-spacing: -0.01em;
        }

        /* Cluster Profile Cards */
        .stat-advanced-card .fw-bold {
            color: #22223b;
        }
        .stat-advanced-card ul {
            margin-bottom: 0.2rem;
            padding-left: 1.1rem;
            font-size: 1rem;
        }
        .stat-advanced-card .badge.bg-dark {
            background: #e0e7ef !important;
            color: #22223b !important;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .stat-advanced-card .badge.bg-light {
            background: #f1f5fa !important;
            color: #5c5c7a !important;
            font-weight: 500;
            font-size: 0.92rem;
        }

        /* Animated Table Rows */
        .animated-table .fade-in-row {
            opacity: 0;
            animation: fadeInRow 0.7s forwards;
        }
        @keyframes fadeInRow {
            to { opacity: 1; }
        }

        /* Notification Cards */
        .alert.animate-in {
            animation: fadeInAlert 0.7s cubic-bezier(.4,0,.2,1);
            border-radius: 1.1rem;
            box-shadow: 0 2px 12px 0 rgba(60,60,100,0.07);
            background: #f8fafc !important;
            color: #22223b !important;
            border: none;
            font-size: 1.08rem;
            padding: 1.1rem 1.2rem;
            margin-bottom: 0.7rem;
        }
        @keyframes fadeInAlert {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: none; }
        }
        .alert-success.animate-in {
            background: linear-gradient(90deg, #e0ffe7 0%, #f8fafc 100%) !important;
            color: #1b5e20 !important;
        }
        .alert-info.animate-in {
            background: linear-gradient(90deg, #e3f0ff 0%, #f8fafc 100%) !important;
            color: #0d47a1 !important;
        }
        .alert-warning.animate-in {
            background: linear-gradient(90deg, #fffbe7 0%, #f8fafc 100%) !important;
            color: #b26a00 !important;
        }
        .alert-danger.animate-in {
            background: linear-gradient(90deg, #ffeaea 0%, #f8fafc 100%) !important;
            color: #b71c1c !important;
        }
        .alert-primary.animate-in {
            background: linear-gradient(90deg, #e3eaff 0%, #f8fafc 100%) !important;
            color: #1a237e !important;
        }

        /* Insight Notification */
        .insight-notification {
            border-left: 5px solid #38b6ff;
            background: #f0faff !important;
            color: #1a237e !important;
            font-weight: 500;
            box-shadow: 0 1px 6px 0 rgba(56,182,255,0.08);
        }

        /* Responsive tweaks */
        @media (max-width: 767px) {
            .stat-advanced-card { font-size: 0.98rem; padding: 0.8rem 0.7rem; }
            .stat-advanced-card .stat-value { font-size: 1.3rem; }
        }

        /* --- Advanced Dropdown Styles for Clustering --- */
        .clustering-section .form-select, .clustering-section .form-control {
            border-radius: 0.9rem;
            background: #f8fafc;
            border: 1.5px solid #e3e8ee;
            box-shadow: 0 1px 6px 0 rgba(60,60,100,0.06);
            font-size: 1.08rem;
            color: #22223b;
            padding: 0.7rem 1.1rem;
        }
        .clustering-section .form-select:focus, .clustering-section .form-control:focus {
            border-color: #38b6ff;
            box-shadow: 0 0 0 2px #b3e5fc;
            background: #f0faff;
            color: #1a237e;
        }
        .clustering-section .form-select[multiple], .clustering-section .form-control[multiple] {
            min-height: 110px;
            background: linear-gradient(135deg, #f8fafc 60%, #e3f0ff 100%);
            border-radius: 1.1rem;
            font-size: 1.05rem;
            color: #1a237e;
            padding: 0.7rem 1.1rem;
        }
        .clustering-section label.form-label {
            font-weight: 600;
            color: #1a237e;
            letter-spacing: 0.01em;
            margin-bottom: 0.3rem;
        }
        .clustering-section .form-select option, .clustering-section .form-control option {
            background: #f8fafc;
            color: #22223b;
            border-radius: 0.7rem;
            padding: 0.3rem 0.7rem;
        }
        .clustering-section .form-select option:checked, .clustering-section .form-control option:checked {
            background: #e3f0ff;
            color: #2563eb;
            font-weight: 600;
        }
        .clustering-section .form-select::-webkit-input-placeholder, .clustering-section .form-control::-webkit-input-placeholder {
            color: #b0b8c1;
        }
        .clustering-section .form-select:disabled, .clustering-section .form-control:disabled {
            background: #f1f5fa;
            color: #b0b8c1;
        }
        @media (max-width: 767px) {
            .clustering-section .form-select, .clustering-section .form-control { font-size: 0.98rem; padding: 0.5rem 0.7rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="dashboard-title">
                        <i class="fas fa-chart-line me-3"></i>
                        Multi-Dimensional Forecasting
                    </h1>
                    <p class="lead mb-0">Advanced forecasting with real-time insights across multiple dimensions</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="window.location.href='/'">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-5" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
        <div class="container">
            
            <!-- Selection Panel -->
            <div class="selection-card">
                <h3 class="text-center mb-4">
                    <i class="fas fa-sliders-h me-2"></i>
                    Select Dimensions for Forecasting
                </h3>
                
                <div class="row">
                    <!-- Cities Selection -->
                    <div class="col-md-4">
                        <h5><i class="fas fa-city me-2"></i>Cities</h5>
                        <div class="multi-select" id="citiesContainer">
                            <select class="form-select" id="citySelect">
                                <option value="">Loading cities...</option>
                            </select>
                            <button class="btn btn-sm btn-primary mt-2" onclick="addCity()">Add City</button>
                            <div id="selectedCities" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- Stores Selection -->
                    <div class="col-md-4">
                        <h5><i class="fas fa-store me-2"></i>Stores</h5>
                        <div class="multi-select" id="storesContainer">
                            <select class="form-select" id="storeSelect">
                                <option value="">Loading stores...</option>
                            </select>
                            <button class="btn btn-sm btn-primary mt-2" onclick="addStore()">Add Store</button>
                            <div id="selectedStores" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- Products Selection -->
                    <div class="col-md-4">
                        <h5><i class="fas fa-box me-2"></i>Products</h5>
                        <div class="multi-select" id="productsContainer">
                            <select class="form-select" id="productSelect">
                                <option value="">Loading products...</option>
                            </select>
                            <button class="btn btn-sm btn-primary mt-2" onclick="addProduct()">Add Product</button>
                            <div id="selectedProducts" class="mt-2"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <label for="forecastDays" class="form-label">Forecast Days</label>
                        <input type="range" class="form-range" id="forecastDays" min="7" max="90" value="30">
                        <div class="d-flex justify-content-between">
                            <span>7 days</span>
                            <span id="forecastDaysValue">30 days</span>
                            <span>90 days</span>
                        </div>
                    </div>
                    <div class="col-md-8 d-flex align-items-end">
                        <div class="row w-100">
                            <div class="col-md-6">
                                <button class="forecast-btn w-100" onclick="generateForecast()">
                                    <i class="fas fa-magic me-2"></i>Sales Forecast
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="demand-forecast-btn w-100" onclick="generateDemandForecast()">
                                    <i class="fas fa-boxes me-2"></i>Demand & Inventory
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notification Container (Top Right) -->
            <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>
            
            <!-- Stopwatch Display -->
            <div class="text-center mb-3" id="stopwatchDisplay" style="font-size: 1.2rem; font-weight: bold; color: #667eea; display: none;">
                Processing time: <span id="elapsedTime">0.00</span> seconds
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generating forecast...</p>
            </div>
            
            <!-- Results Container -->
            <div class="results-container" id="resultsContainer" style="display: none;">
                
                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs" id="forecastTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>Sales Forecast
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="demand-tab" data-bs-toggle="tab" data-bs-target="#demand" type="button" role="tab">
                            <i class="fas fa-boxes me-2"></i>Demand & Inventory
                        </button>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="weather-tab" data-bs-toggle="tab" href="#weather-content" role="tab">
                            <i class="fas fa-cloud-sun me-2"></i>Weather & Holiday Forecasting
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="clustering-tab" data-bs-toggle="tab" data-bs-target="#clustering" type="button" role="tab">
                            <i class="fas fa-project-diagram me-2"></i>Clustering & Segmentation
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="forecastTabContent">
                    
                    <!-- Sales Forecast Tab -->
                    <div class="tab-pane fade show active" id="sales" role="tabpanel">
                        
                        <!-- Summary Stats -->
                        <div class="summary-stats" id="summaryStats">
                            <h4><i class="fas fa-chart-bar me-2"></i>Sales Forecast Summary</h4>
                            <div class="stat-grid" id="statGrid">
                                <!-- Stats will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Forecast Chart -->
                        <div class="chart-container">
                            <canvas id="forecastChart"></canvas>
                        </div>
                        
                        <!-- Product Sales by City-Store Chart -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-gradient-primary text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-bar me-2"></i>
                                                Product Sales by City-Store
                                            </h5>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-light" id="viewAllBtn">
                                                    <i class="fas fa-eye me-1"></i>View All
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-light" id="filterBtn">
                                                    <i class="fas fa-filter me-1"></i>Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Filter Controls (initially hidden) -->
                                        <div id="productFilterControls" class="mb-3" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">Filter by Products:</label>
                                                    <select class="form-select" id="productFilter" multiple>
                                                        <!-- Products will be populated here -->
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Filter by Cities:</label>
                                                    <select class="form-select" id="cityFilter" multiple>
                                                        <!-- Cities will be populated here -->
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Filter by Stores:</label>
                                                    <select class="form-select" id="storeFilter" multiple>
                                                        <!-- Stores will be populated here -->
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <button type="button" class="btn btn-primary btn-sm" id="applyFilterBtn">
                                                    <i class="fas fa-check me-1"></i>Apply Filters
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm ms-2" id="resetFilterBtn">
                                                    <i class="fas fa-undo me-1"></i>Reset
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Chart Container -->
                                        <div class="chart-container">
                                            <canvas id="productSalesChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Insights Section -->
                        <div class="row" id="insightsSection">
                            <div class="col-12">
                                <h3 class="text-center mb-4">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    Business Insights
                                </h3>
                                <div id="insightsContainer">
                                    <!-- Insights will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparative Analysis -->
                        <div class="row mt-4" id="comparativeSection">
                            <div class="col-12">
                                <h3 class="text-center mb-4">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    Comparative Analysis
                                </h3>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="comparison-card">
                                            <h6>City Performance</h6>
                                            <div id="cityComparison"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="comparison-card">
                                            <h6>Store Performance</h6>
                                            <div id="storeComparison"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="comparison-card">
                                            <h6>Product Performance</h6>
                                            <div id="productComparison"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparative Insights -->
                        <div class="row mt-4" id="comparativeInsights">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h5><i class="fas fa-info-circle me-2"></i>Key Insights</h5>
                                    <div id="keyInsights"></div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Demand & Inventory Tab -->
                    <div class="tab-pane fade" id="demand" role="tabpanel">
                        
                        <!-- Inventory Status Overview -->
                        <div class="summary-stats" id="inventoryOverview">
                            <h4><i class="fas fa-warehouse me-2"></i>Inventory Status Overview</h4>
                            <div class="stat-grid" id="inventoryStatGrid">
                                <!-- Inventory stats will be populated here -->
                            </div>
                        </div>
                        <!-- Stockout Risk Chart + Demand Forecast Chart Row (side by side, 20/80 split) -->
                        <div class="row g-4 align-items-stretch mb-4">
                            <div class="col-lg-3 col-md-5 col-12 d-flex align-items-stretch align-items-center justify-content-center">
                                <div class="card h-100 p-3 shadow-sm d-flex align-items-center justify-content-center" style="height: 100%; min-height: 100%; max-height: none;">
                                    <canvas id="stockoutRiskChart" style="height: 100% !important; width: 100% !important; aspect-ratio: 1 / 1; display: block; margin: 0 auto;"></canvas>
                        </div>
                            </div>
                            <div class="col-lg-9 col-md-7 col-12">
                                <div class="card h-100 p-3 shadow-sm" style="max-height: 500px; overflow-x: auto; overflow-y: hidden;">
                            <canvas id="demandForecastChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inventory Status Cards -->
                        <div class="row mt-4" id="inventoryStatusSection">
                            <div class="col-12">
                                <h3 class="text-center mb-4">
                                    <i class="fas fa-clipboard-list me-2"></i>
                                    Inventory Status
                                </h3>
                                <div id="inventoryStatusContainer">
                                    <!-- Inventory status cards will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Demand Insights -->
                        <div class="row mt-4" id="demandInsightsSection">
                            <div class="col-12">
                                <h3 class="text-center mb-4">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Demand Insights & Alerts
                                </h3>
                                <div id="demandInsightsContainer">
                                    <!-- Demand insights will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inventory Recommendations -->
                        <div class="row mt-4" id="recommendationsSection">
                            <div class="col-12">
                                <h3 class="text-center mb-4">
                                    <i class="fas fa-tasks me-2"></i>
                                    Inventory Recommendations
                                </h3>
                                <div id="recommendationsContainer">
                                    <!-- Recommendations will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Weather & Holiday Forecasting Tab -->
                    <div class="tab-pane fade" id="weather-content" role="tabpanel">
                        <!-- Weather Controls -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="weather-controls-card">
                                    <h5><i class="fas fa-sliders-h me-2"></i>Promotional Analysis Controls</h5>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="discountPercentage" class="form-label">Discount Percentage</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="discountPercentage" value="5" min="0" max="50" step="1">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="promotionDuration" class="form-label">Promotion Duration</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="promotionDuration" value="7" min="1" max="30" step="1">
                                                <span class="input-group-text">days</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button class="btn btn-primary d-block" onclick="generateWeatherForecast()">
                                                <i class="fas fa-cloud-sun me-2"></i>Generate Weather Forecast
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button class="btn btn-info d-block" onclick="showWeatherNotifications()">
                                                <i class="fas fa-bell me-2"></i>Show Weather Alerts
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weather Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div id="weatherSummaryCards"></div>
                            </div>
                        </div>
                        
                        <!-- Weather Recommendations -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="weather-section-card">
                                    <h5><i class="fas fa-thermometer-half me-2"></i>Weather-Based Recommendations</h5>
                                    <div id="weatherRecommendationsContainer"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="weather-section-card">
                                    <h5><i class="fas fa-gift me-2"></i>Holiday Impact Analysis</h5>
                                    <div id="holidayAnalysisContainer"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Promotional Analysis -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="weather-section-card">
                                    <h5><i class="fas fa-percentage me-2"></i>Promotional Impact Analysis</h5>
                                    <div id="promotionalAnalysisContainer"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bundle Recommendations -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="weather-section-card">
                                    <h5><i class="fas fa-boxes me-2"></i>Weather-Based Bundle Recommendations</h5>
                                    <div id="bundleRecommendationsContainer"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="weather-section-card">
                                    <h5><i class="fas fa-calendar-alt me-2"></i>Seasonal Insights</h5>
                                    <div id="seasonalInsightsContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="clustering" role="tabpanel">
                        <div class="card mt-4 clustering-section">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Clustering & Segmentation</h5>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs mt-2" id="clusteringTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="store-clustering-tab" data-bs-toggle="tab" data-bs-target="#store-clustering" type="button" role="tab">
                                            <i class="fas fa-store me-2"></i>Store Clustering
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="product-clustering-tab" data-bs-toggle="tab" data-bs-target="#product-clustering" type="button" role="tab">
                                            <i class="fas fa-box me-2"></i>Product Clustering
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="city-clustering-tab" data-bs-toggle="tab" data-bs-target="#city-clustering" type="button" role="tab">
                                            <i class="fas fa-city me-2"></i>City Clustering
                                        </button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="clusteringTabContent">
                                    <!-- Store Clustering Tab -->
                                    <div class="tab-pane fade show active" id="store-clustering" role="tabpanel">
                                        <div class="row mb-3 mt-3">
                                            <div class="col-md-3">
                                                <label for="storeClusteringAlgorithm" class="form-label">Algorithm</label>
                                                <select class="form-select" id="storeClusteringAlgorithm">
                                                    <option value="kmeans">K-Means</option>
                                                    <option value="dbscan">DBSCAN</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="storeClusteringFeatures" class="form-label">Features</label>
                                                <select class="form-select" id="storeClusteringFeatures" multiple>
                                                    <option value="demand_profile" selected>Demand Profile</option>
                                                    <option value="stockout_rate" selected>Stockout Rate</option>
                                                    <option value="discount_response">Discount Response</option>
                                                    <option value="weather_sensitivity">Weather Sensitivity</option>
                                                </select>
                                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="storeClusteringNClusters" class="form-label"># Clusters</label>
                                                <input type="number" class="form-control" id="storeClusteringNClusters" min="2" max="10" value="3">
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-success w-100" onclick="runStoreClustering()">
                                                    <i class="fas fa-play me-2"></i>Run Store Clustering
                                                </button>
                                            </div>
                                        </div>
                                        <div id="storeClusteringResults"></div>
                                    </div>
                                    <!-- Product Clustering Tab -->
                                    <div class="tab-pane fade" id="product-clustering" role="tabpanel">
                                        <div class="row mb-3 mt-3">
                                            <div class="col-md-3">
                                                <label for="productClusteringAlgorithm" class="form-label">Algorithm</label>
                                                <select class="form-select" id="productClusteringAlgorithm">
                                                    <option value="kmeans">K-Means</option>
                                                    <option value="dbscan">DBSCAN</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="productClusteringFeatures" class="form-label">Features</label>
                                                <select class="form-select" id="productClusteringFeatures" multiple>
                                                    <option value="demand_profile" selected>Demand Profile</option>
                                                    <option value="stockout_rate" selected>Stockout Rate</option>
                                                    <option value="discount_response">Discount Response</option>
                                                    <option value="weather_sensitivity">Weather Sensitivity</option>
                                                </select>
                                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="productClusteringNClusters" class="form-label"># Clusters</label>
                                                <input type="number" class="form-control" id="productClusteringNClusters" min="2" max="10" value="3">
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-success w-100" onclick="runProductClustering()">
                                                    <i class="fas fa-play me-2"></i>Run Product Clustering
                                                </button>
                                            </div>
                                        </div>
                                        <div id="productClusteringResults"></div>
                                    </div>
                                    <!-- City Clustering Tab -->
                                    <div class="tab-pane fade" id="city-clustering" role="tabpanel">
                                        <div class="row mb-3 mt-3">
                                            <div class="col-md-3">
                                                <label for="cityClusteringAlgorithm" class="form-label">Algorithm</label>
                                                <select class="form-select" id="cityClusteringAlgorithm">
                                                    <option value="kmeans">K-Means</option>
                                                    <option value="dbscan">DBSCAN</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="cityClusteringFeatures" class="form-label">Features</label>
                                                <select class="form-select" id="cityClusteringFeatures" multiple>
                                                    <option value="demand_profile" selected>Demand Profile</option>
                                                    <option value="stockout_rate" selected>Stockout Rate</option>
                                                    <option value="discount_response">Discount Response</option>
                                                    <option value="weather_sensitivity">Weather Sensitivity</option>
                                                </select>
                                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="cityClusteringNClusters" class="form-label"># Clusters</label>
                                                <input type="number" class="form-control" id="cityClusteringNClusters" min="2" max="10" value="3">
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-success w-100" onclick="runCityClustering()">
                                                    <i class="fas fa-play me-2"></i>Run City Clustering
                                                </button>
                                            </div>
                                        </div>
                                        <div id="cityClusteringResults"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Weather Notification Modal -->
    <div class="modal fade" id="weatherNotificationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cloud-sun me-2"></i>Weather-Based Alerts & Notifications
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="weatherNotificationContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Weather Detail Modal -->
    <div class="modal fade" id="productWeatherModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-box me-2"></i>Product Weather Analysis
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="productWeatherContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotional Alert Modal -->
    <div class="modal fade" id="promotionalAlertModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-percent me-2"></i>Promotional Campaign Recommendations
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="promotionalAlertContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let selectedCities = [];
        let selectedStores = [];
        let selectedProducts = [];
        let forecastChart = null;
        let stockoutRiskChart = null;
        let demandForecastChart = null;
        let weatherForecastData = null;
        
        // --- Enhanced Dropdown Filtering Logic ---
        let allStores = [];
        let allProducts = [];
        let allCities = [];
        
        async function loadDropdownData() {
            try {
                // Load cities
                const citiesResponse = await fetch('/api/cities');
                const cities = await citiesResponse.json();
                allCities = cities;
                const citySelect = document.getElementById('citySelect');
                citySelect.innerHTML = '<option value="">Select a city...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.city_id;
                    option.textContent = city.city_name;
                    citySelect.appendChild(option);
                });
                
                // Load stores
                const storesResponse = await fetch('/api/stores');
                const stores = await storesResponse.json();
                allStores = stores;
                updateStoreDropdown();

                // Load products
                const productsResponse = await fetch('/api/products');
                const products = await productsResponse.json();
                allProducts = products;
                updateProductDropdown();
            } catch (error) {
                console.error('Error loading dropdown data:', error);
            }
        }

        function updateStoreDropdown() {
                const storeSelect = document.getElementById('storeSelect');
                storeSelect.innerHTML = '<option value="">Select a store...</option>';
            let filteredStores = allStores;
            if (selectedCities.length > 0) {
                const cityIds = selectedCities.map(c => c.id);
                filteredStores = allStores.filter(store => cityIds.includes(parseInt(store.city_id)));
            }
            filteredStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.store_id;
                    option.textContent = `${store.store_name} (${store.city_name || 'Unknown City'})`;
                    storeSelect.appendChild(option);
                });
        }
                
        function updateProductDropdown() {
                const productSelect = document.getElementById('productSelect');
                productSelect.innerHTML = '<option value="">Select a product...</option>';
            let filteredProducts = allProducts;
            if (selectedCities.length > 0) {
                // Optionally, filter products by city if you have city-product mapping
                // For now, show all products (or use valid-products API if needed)
            }
            filteredProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.product_id;
                    option.textContent = product.product_name;
                    productSelect.appendChild(option);
                });
        }

        // Add search/filter to dropdowns
        function addDropdownSearch(selectId) {
            const select = document.getElementById(selectId);
            const container = select.parentElement;
            const search = document.createElement('input');
            search.type = 'text';
            search.className = 'dropdown-search';
            search.placeholder = 'Search...';
            container.insertBefore(search, select);
            search.addEventListener('input', function() {
                const filter = this.value.toLowerCase();
                Array.from(select.options).forEach(option => {
                    if (option.value === '') return; // keep default
                    option.style.display = option.textContent.toLowerCase().includes(filter) ? '' : 'none';
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadDropdownData().then(() => {
                addDropdownSearch('citySelect');
                addDropdownSearch('storeSelect');
                addDropdownSearch('productSelect');
            });
        });

        // --- Update stores/products when cities change ---
        function addCity() {
            console.log('addCity called');
            const citySelect = document.getElementById('citySelect');
            const cityId = parseInt(citySelect.value); // Convert to integer
            const cityName = citySelect.options[citySelect.selectedIndex].text;
            if (cityId && !selectedCities.find(c => c.id === cityId)) {
                selectedCities.push({id: cityId, name: cityName});
                updateSelectedDisplay('selectedCities', selectedCities, removeCity);
                citySelect.value = '';
                updateStoreDropdown();
                updateProductDropdown();
                updateValidProducts();
            }
        }
        function removeCity(index) {
            selectedCities.splice(index, 1);
            updateSelectedDisplay('selectedCities', selectedCities, removeCity);
            updateStoreDropdown();
            updateProductDropdown();
            updateValidProducts();
        }
        function addStore() {
            const storeSelect = document.getElementById('storeSelect');
            const storeId = parseInt(storeSelect.value); // Convert to integer
            const storeName = storeSelect.options[storeSelect.selectedIndex].text;
            if (storeId && !selectedStores.find(s => s.id === storeId)) {
                selectedStores.push({id: storeId, name: storeName});
                updateSelectedDisplay('selectedStores', selectedStores, removeStore);
                storeSelect.value = '';
                updateProductDropdown();
                updateValidProducts();
            }
        }
        function removeStore(index) {
            selectedStores.splice(index, 1);
            updateSelectedDisplay('selectedStores', selectedStores, removeStore);
            updateProductDropdown();
            updateValidProducts();
        }
        function addProduct() {
            const productSelect = document.getElementById('productSelect');
            const productId = parseInt(productSelect.value); // Convert to integer
            const productName = productSelect.options[productSelect.selectedIndex].text;
            if (productId && !selectedProducts.find(p => p.id === productId)) {
                selectedProducts.push({id: productId, name: productName});
                updateSelectedDisplay('selectedProducts', selectedProducts, removeProduct);
                productSelect.value = '';
            }
        }
        function removeProduct(index) {
            selectedProducts.splice(index, 1);
            updateSelectedDisplay('selectedProducts', selectedProducts, removeProduct);
        }
        // Make these functions accessible from HTML onclick
        window.addCity = addCity;
        window.removeCity = removeCity;
        window.addStore = addStore;
        window.removeStore = removeStore;
        window.addProduct = addProduct;
        window.removeProduct = removeProduct;
        
        // Loading functions
        function showLoading() {
            // Create loading overlay if it doesn't exist
            if (!document.getElementById('loadingOverlay')) {
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loadingOverlay';
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                loadingOverlay.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 10px; text-align: center;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Processing weather forecast...</p>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
            }
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDropdownData();
            setupEventListeners();
            connectWebSocket(); // Establish WebSocket connection on page load
        });
        
        function setupEventListeners() {
            const forecastDaysSlider = document.getElementById('forecastDays');
            const forecastDaysValue = document.getElementById('forecastDaysValue');
            
            forecastDaysSlider.addEventListener('input', function() {
                forecastDaysValue.textContent = this.value + ' days';
            });
        }
        
        async function updateValidProducts() {
            // Only update if we have cities or stores selected
            if (selectedCities.length === 0 && selectedStores.length === 0) {
                return;
            }
            
            try {
                const response = await fetch('/api/valid-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city_ids: selectedCities.map(c => c.id),
                        store_ids: selectedStores.map(s => s.id)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const productSelect = document.getElementById('productSelect');
                    productSelect.innerHTML = '<option value="">Select a product...</option>';
                    
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.product_id;
                        option.textContent = `${product.product_name} (${product.sales_records} records)`;
                        productSelect.appendChild(option);
                    });
                    
                    // Clear selected products as they might not be valid anymore
                    selectedProducts = [];
                    updateSelectedDisplay('selectedProducts', selectedProducts, removeProduct);
                    
                    // Show info about available products
                    console.log(`Updated products: ${data.products.length} products available`);
                }
            } catch (error) {
                console.error('Error updating valid products:', error);
            }
        }
        
        async function generateForecast() {
            if (selectedCities.length === 0 || selectedStores.length === 0 || selectedProducts.length === 0) {
                alert('Please select at least one city, store, and product.');
                return;
            }
            
            const forecastDays = parseInt(document.getElementById('forecastDays').value);
            
            // Start stopwatch
            const startTime = performance.now();
            document.getElementById('stopwatchDisplay').style.display = 'none';

            // Show loading
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            
            try {
                const response = await fetch('/api/multi-dimensional-forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city_ids: selectedCities.map(c => String(c.id)),
                        store_ids: selectedStores.map(s => String(s.id)),
                        product_ids: selectedProducts.map(p => parseInt(p.id)),
                        forecast_days: forecastDays,
                        include_insights: true,
                        model_type: 'ensemble'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Forecast generation failed');
                }
                
                const data = await response.json();
                
                // Stop stopwatch and display time
                const endTime = performance.now();
                const elapsedTime = ((endTime - startTime) / 1000).toFixed(2);
                document.getElementById('elapsedTime').textContent = elapsedTime;
                document.getElementById('stopwatchDisplay').style.display = 'block';

                // Hide loading
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
                
                // Switch to sales tab
                document.getElementById('sales-tab').click();
                
                // Display results
                displayForecastResults(data);
                
            } catch (error) {
                console.error('Error generating forecast:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('stopwatchDisplay').style.display = 'none'; // Hide on error
                alert('Error generating forecast. Please try again.');
            }
        }
        
        async function generateDemandForecast() {
            if (selectedCities.length === 0 || selectedStores.length === 0 || selectedProducts.length === 0) {
                alert('Please select at least one city, store, and product.');
                return;
            }
            
            const forecastDays = parseInt(document.getElementById('forecastDays').value);
            
            // Start stopwatch
            const startTime = performance.now();
            document.getElementById('stopwatchDisplay').style.display = 'none';

            // Show loading
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            
            try {
                const response = await fetch('/api/demand-forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city_ids: selectedCities.map(c => c.id),
                        store_ids: selectedStores.map(s => s.id),
                        product_ids: selectedProducts.map(p => parseInt(p.id)),
                        forecast_days: forecastDays
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Demand forecast generation failed');
                }
                
                const data = await response.json();
                
                // Stop stopwatch and display time
                const endTime = performance.now();
                const elapsedTime = ((endTime - startTime) / 1000).toFixed(2);
                document.getElementById('elapsedTime').textContent = elapsedTime;
                document.getElementById('stopwatchDisplay').style.display = 'block';

                // Hide loading
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
                
                // Switch to demand tab
                document.getElementById('demand-tab').click();
                
                // Display results
                displayDemandForecastResults(data);
                
            } catch (error) {
                console.error('Error generating demand forecast:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('stopwatchDisplay').style.display = 'none'; // Hide on error
                alert('Error generating demand forecast. Please try again.');
            }
        }
        
        function displayForecastResults(data) {
            // Display summary stats
            displaySummaryStats(data.summary);
            
            // Display forecast chart
            displayForecastChart(data.forecast_data);
            
            // Display product sales chart
            displayProductSalesChart(data.forecast_data);
            
            // Display insights
            displayInsights(data.insights);
            
            // Display comparative analysis
            displayComparativeAnalysis(data.comparative_analysis);
        }
        
        function displayDemandForecastResults(data) {
            // Display inventory overview
            displayInventoryOverview(data.inventory_status);
            
            // Display stockout risk chart
                            displayStockoutRiskChart(data.stockout_risk_analysis, data.inventory_status);
            
            // Display demand forecast chart
            displayDemandForecastChart(data.inventory_status);
            
            // Display inventory status cards
            displayInventoryStatusCards(data.inventory_status);
            
            // Display demand insights
            displayDemandInsights(data.demand_insights);
            
            // Display recommendations
            displayInventoryRecommendations(data.inventory_recommendations);
        }
        
        function displayInventoryOverview(inventoryStatus) {
            const statGrid = document.getElementById('inventoryStatGrid');
            statGrid.innerHTML = '';
            if (!inventoryStatus || inventoryStatus.length === 0) {
                statGrid.innerHTML = '<div class="col-12 text-center">No inventory data available</div>';
                return;
            }
            const totalProducts = inventoryStatus.length;
            const criticalItems = inventoryStatus.filter(item => item.stockout_risk_score >= 0.8).length;
            const highRiskItems = inventoryStatus.filter(item => item.stockout_risk_score >= 0.6).length;
            const avgStockLevel = inventoryStatus.reduce((sum, item) => sum + item.current_stock_level, 0) / totalProducts;
            const avgDaysUntilStockout = inventoryStatus.reduce((sum, item) => sum + item.days_until_stockout, 0) / totalProducts;
            // Animated counter helper
            function animateValue(id, start, end, duration, suffix = '', decimals = 1) {
                const obj = document.getElementById(id);
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = start + (end - start) * progress;
                    obj.textContent = value.toFixed(decimals) + suffix;
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }
            // Card HTML
            statGrid.innerHTML = `
                <div class="row g-3 align-items-center inventory-overview-advanced animate-in">
                    <div class="col-6 col-md-2">
                        <div class="stat-advanced-card gradient-blue shadow-sm" title="Total number of products analyzed">
                            <div class="stat-icon-advanced"><i class="fas fa-boxes"></i></div>
                            <div class="stat-value-advanced" id="invTotalProducts">0</div>
                            <div class="stat-label-advanced">Products Analyzed</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="stat-advanced-card gradient-red shadow-sm" title="Number of products at critical stockout risk (score â‰¥ 0.8)">
                            <div class="stat-icon-advanced"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="stat-value-advanced" id="invCriticalItems">0</div>
                            <div class="stat-label-advanced">Critical Risk</div>
                            <div class="progress mt-2" style="height: 7px;">
                                <div class="progress-bar bg-danger" id="invCriticalBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="stat-advanced-card gradient-orange shadow-sm" title="Number of products at high stockout risk (score â‰¥ 0.6)">
                            <div class="stat-icon-advanced"><i class="fas fa-bolt"></i></div>
                            <div class="stat-value-advanced" id="invHighRiskItems">0</div>
                            <div class="stat-label-advanced">High Risk</div>
                            <div class="progress mt-2" style="height: 7px;">
                                <div class="progress-bar bg-warning" id="invHighRiskBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-advanced-card gradient-teal shadow-sm" title="Average stock level across all products">
                            <div class="stat-icon-advanced"><i class="fas fa-layer-group"></i></div>
                            <div class="stat-value-advanced" id="invAvgStockLevel">0</div>
                            <div class="stat-label-advanced">Avg Stock Level</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-advanced-card gradient-green shadow-sm" title="Average days until stockout across all products">
                            <div class="stat-icon-advanced"><i class="fas fa-clock"></i></div>
                            <div class="stat-value-advanced" id="invAvgDaysUntilStockout">0</div>
                            <div class="stat-label-advanced">Avg Days Until Stockout</div>
                        </div>
                    </div>
                </div>
            `;
            // Animate numbers and progress bars
            setTimeout(() => {
                animateValue('invTotalProducts', 0, totalProducts, 1000, '', 0);
                animateValue('invCriticalItems', 0, criticalItems, 1000, '', 0);
                animateValue('invHighRiskItems', 0, highRiskItems, 1000, '', 0);
                animateValue('invAvgStockLevel', 0, avgStockLevel, 1200, '', 0);
                animateValue('invAvgDaysUntilStockout', 0, avgDaysUntilStockout, 1200, '', 0);
                document.getElementById('invCriticalBar').style.width = `${((criticalItems / totalProducts) * 100).toFixed(1)}%`;
                document.getElementById('invHighRiskBar').style.width = `${((highRiskItems / totalProducts) * 100).toFixed(1)}%`;
            }, 200);
        }
        
        function displayStockoutRiskChart(stockoutRiskAnalysis, inventoryStatus) {
            const ctx = document.getElementById('stockoutRiskChart').getContext('2d');
            if (stockoutRiskChart) {
                stockoutRiskChart.destroy();
            }
            if (!inventoryStatus || inventoryStatus.length === 0) {
                return;
            }
            // Prepare data for donut chart
            const riskLevels = {
                'Critical (>80%)': 0,
                'High (60-80%)': 0,
                'Medium (40-60%)': 0,
                'Low (<40%)': 0
            };
            inventoryStatus.forEach(item => {
                const riskScore = item.stockout_risk_score || 0;
                if (riskScore >= 0.8) {
                    riskLevels['Critical (>80%)']++;
                } else if (riskScore >= 0.6) {
                    riskLevels['High (60-80%)']++;
                } else if (riskScore >= 0.4) {
                    riskLevels['Medium (40-60%)']++;
                } else {
                    riskLevels['Low (<40%)']++;
                }
            });
            // AI-inspired gradients
            const donutColors = [
                ctx.createLinearGradient(0, 0, 0, 220), // Critical
                ctx.createLinearGradient(0, 0, 0, 220), // High
                ctx.createLinearGradient(0, 0, 0, 220), // Medium
                ctx.createLinearGradient(0, 0, 0, 220)  // Low
            ];
            donutColors[0].addColorStop(0, '#ff5252'); donutColors[0].addColorStop(1, '#ff8a8a');
            donutColors[1].addColorStop(0, '#ffb300'); donutColors[1].addColorStop(1, '#ffd180');
            donutColors[2].addColorStop(0, '#26c6da'); donutColors[2].addColorStop(1, '#b2ebf2');
            donutColors[3].addColorStop(0, '#43a047'); donutColors[3].addColorStop(1, '#b9f6ca');
            const borderColors = ['#ff5252', '#ffb300', '#26c6da', '#43a047'];
            // Find highest risk category
            const maxIndex = Object.values(riskLevels).reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
            const total = Object.values(riskLevels).reduce((a, b) => a + b, 0);
            const maxPercent = total > 0 ? ((Object.values(riskLevels)[maxIndex] / total) * 100).toFixed(0) : 0;
            const maxLabel = Object.keys(riskLevels)[maxIndex];
            // Draw donut chart
            stockoutRiskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(riskLevels),
                    datasets: [{
                        label: 'Stockout Risk',
                        data: Object.values(riskLevels),
                        backgroundColor: donutColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        hoverOffset: 14,
                        shadowOffsetX: 0,
                        shadowOffsetY: 2,
                        shadowBlur: 12,
                        shadowColor: 'rgba(38,98,218,0.13)'
                    }]
                },
                options: {
                    responsive: true,
                    animation: { animateRotate: true, animateScale: true, duration: 1400, easing: 'easeOutQuart' },
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                        tooltip: {
                            backgroundColor: '#fff',
                            titleColor: '#1a237e',
                            bodyColor: '#333',
                            borderColor: '#2563eb',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    const icons = ['ðŸ”¥', 'âš¡', 'ðŸ’§', 'ðŸŒ±'];
                                    return `${icons[context.dataIndex]} ${label}: ${value} items (${percent}%)`;
                                }
                            }
                        }
                    },
                    cutout: '78%',
                    layout: { padding: 10 },
                    hover: { mode: 'nearest', intersect: true },
                    elements: { arc: { borderWidth: 2, borderColor: '#fff', shadowBlur: 10, shadowColor: 'rgba(38,98,218,0.13)' } }
                },
                plugins: [
                    // Center percentage and label
                    {
                        id: 'doughnutlabel',
                        afterDraw(chart) {
                            const {ctx, chartArea, data} = chart;
                            if (!data.datasets.length) return;
                            ctx.save();
                            ctx.font = 'bold 2.1rem Arial';
                            ctx.fillStyle = borderColors[maxIndex];
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${maxPercent}%`, (chartArea.left + chartArea.right) / 2, (chartArea.top + chartArea.bottom) / 2 - 8);
                            ctx.font = '1rem Arial';
                            ctx.fillStyle = '#888';
                            ctx.fillText(maxLabel.split(' ')[0], (chartArea.left + chartArea.right) / 2, (chartArea.top + chartArea.bottom) / 2 + 18);
                            ctx.restore();
                        }
                    },
                    // Animated legend
                    {
                        id: 'animatedLegend',
                        afterDraw(chart) {
                            const legendContainer = ctx.canvas.parentElement.querySelector('.doughnut-legend');
                            if (legendContainer) legendContainer.remove();
                            const newLegend = document.createElement('div');
                            newLegend.className = 'doughnut-legend mt-2 animate-in';
                            const icons = ['ðŸ”¥', 'âš¡', 'ðŸ’§', 'ðŸŒ±'];
                            Object.keys(riskLevels).forEach((label, i) => {
                                const swatch = `<span class="legend-pill" tabindex="0"><span class="legend-color" style="background:${borderColors[i]}"></span>${icons[i]} ${label}</span>`;
                                newLegend.innerHTML += swatch;
                            });
                            ctx.canvas.parentElement.appendChild(newLegend);
                        }
                    }
                ]
            });
        }
        
        function displayDemandForecastChart(inventoryStatus) {
            const canvas = document.getElementById('demandForecastChart');
            const ctx = canvas.getContext('2d');
            if (demandForecastChart) {
                demandForecastChart.destroy();
            }
            if (!inventoryStatus || inventoryStatus.length === 0) {
                return;
            }
            // Prepare data
            const fullLabels = inventoryStatus.map(item => `${item.product_name} (${item.store_name})`);
            const labels = fullLabels;
            const stockData = inventoryStatus.map(item => item.current_stock_level);
            const demandData = inventoryStatus.map(item => item.avg_daily_demand * 30); // 30-day demand
            // Gradients for bars
            const stockGradient = ctx.createLinearGradient(0, 0, 300, 0);
            stockGradient.addColorStop(0, '#43a047'); stockGradient.addColorStop(1, '#b9f6ca');
            const demandGradient = ctx.createLinearGradient(0, 0, 300, 0);
            demandGradient.addColorStop(0, '#ffb300'); demandGradient.addColorStop(1, '#ffd180');
            // Bar colors: green if stock >= demand, red if below
            const barColors = stockData.map((stock, i) => stock >= demandData[i] ? stockGradient : '#ff5252');
            // Set chart height dynamically
            const chartHeight = Math.min(Math.max(labels.length * 40, 200), 500);
            canvas.style.height = chartHeight + 'px';
            canvas.height = chartHeight;
            // Draw chart
            demandForecastChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                        label: 'Current Stock',
                        data: stockData,
                            backgroundColor: barColors,
                            borderColor: barColors,
                            borderWidth: 1,
                            barPercentage: 0.7,
                            categoryPercentage: 0.7,
                            borderRadius: 8,
                            shadowOffsetX: 0,
                            shadowOffsetY: 2,
                            shadowBlur: 10,
                            shadowColor: 'rgba(67,160,71,0.13)'
                        },
                        {
                        label: '30-Day Demand Forecast',
                        data: demandData,
                            backgroundColor: demandGradient,
                            borderColor: demandGradient,
                            borderWidth: 1,
                            barPercentage: 0.7,
                            categoryPercentage: 0.7,
                            borderRadius: 8,
                            shadowOffsetX: 0,
                            shadowOffsetY: 2,
                            shadowBlur: 10,
                            shadowColor: 'rgba(255,179,0,0.13)'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1400,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Current Stock vs 30-Day Demand Forecast',
                            color: '#1a237e',
                            font: { size: 18, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: '#fff',
                            titleColor: '#1a237e',
                            bodyColor: '#333',
                            borderColor: '#2563eb',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    const idx = context[0].dataIndex;
                                    return fullLabels[idx];
                                },
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    if (context.dataset.label === 'Current Stock') {
                                        return `ðŸŸ© Current Stock: ${stockData[idx]} units`;
                                    } else {
                                        return `ðŸŸ¨ 30-Day Demand: ${demandData[idx].toFixed(0)} units`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units',
                                color: '#1a237e',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                font: { size: 12 },
                                color: '#333'
                            },
                            grid: { color: '#e3f0fc' }
                        },
                        y: {
                            title: { display: false },
                            ticks: {
                                font: { size: 12 },
                                color: '#333',
                                autoSkip: false
                            },
                            grid: { color: '#f8fafd' }
                        }
                    }
                },
                plugins: [
                    // Custom legend plugin
                    {
                        id: 'customLegend',
                        afterDraw(chart) {
                            const legendId = 'demand-bar-legend';
                            let legend = document.getElementById(legendId);
                            if (legend) legend.remove();
                            legend = document.createElement('div');
                            legend.id = legendId;
                            legend.className = 'doughnut-legend mt-2 animate-in';
                            legend.innerHTML = `
                                <span class="legend-pill" tabindex="0"><span class="legend-color" style="background:#43a047"></span>ðŸŸ© Current Stock</span>
                                <span class="legend-pill" tabindex="0"><span class="legend-color" style="background:#ffb300"></span>ðŸŸ¨ 30-Day Demand</span>
                                <span class="legend-pill" tabindex="0"><span class="legend-color" style="background:#ff5252"></span>ðŸ”´ Stock Below Demand</span>
                            `;
                            chart.canvas.parentElement.appendChild(legend);
                        }
                    }
                ]
            });
        }
        
        function displayInventoryStatusCards(inventoryStatus) {
            const container = document.getElementById('inventoryStatusContainer');
            container.innerHTML = '';
            if (!inventoryStatus || inventoryStatus.length === 0) {
                container.innerHTML = '<div class="text-center">No inventory data available</div>';
                return;
            }
            // Card grid
            const row = document.createElement('div');
            row.className = 'row g-4';
            inventoryStatus.forEach(item => {
                const urgencyClass = item.stockout_risk_score >= 0.8 ? 'critical' : 
                                   item.stockout_risk_score >= 0.6 ? 'high' :
                                   item.stockout_risk_score >= 0.4 ? 'medium' : 'low';
                let statusText = '';
                let statusIcon = '';
                let statusColor = '';
                let barGradient = '';
                if (urgencyClass === 'critical') {
                    statusText = 'Stockout Imminent';
                    statusIcon = 'fa-exclamation-triangle';
                    statusColor = 'danger';
                    barGradient = 'linear-gradient(90deg, #ff6b6b 0%, #ffb3b3 100%)';
                } else if (urgencyClass === 'high') {
                    statusText = 'Reorder Now';
                    statusIcon = 'fa-bolt';
                    statusColor = 'warning';
                    barGradient = 'linear-gradient(90deg, #ffb74d 0%, #ffe0b2 100%)';
                } else if (urgencyClass === 'medium') {
                    statusText = 'Monitor Closely';
                    statusIcon = 'fa-info-circle';
                    statusColor = 'info';
                    barGradient = 'linear-gradient(90deg, #26c6da 0%, #b2ebf2 100%)';
                } else {
                    statusText = 'Healthy';
                    statusIcon = 'fa-check-circle';
                    statusColor = 'success';
                    barGradient = 'linear-gradient(90deg, #43a047 0%, #b9f6ca 100%)';
                }
                // Mini-trend (sparkline) for stock/demand (optional, placeholder)
                const sparkline = `<span class=\"sparkline\" title=\"Stock trend (placeholder)\">â–â–‚â–ƒâ–„â–…â–†â–‡</span>`;
                // Card
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 col-12 d-flex align-items-stretch';
                col.innerHTML = `
                    <div class=\"inventory-status-card ${urgencyClass} shadow-sm h-100 position-relative d-flex flex-column justify-content-between\">
                        <div class=\"stockout-risk-badge-row w-100 d-flex justify-content-center align-items-center mb-1\">
                            <span class=\"badge bg-light text-dark stockout-risk-badge-center\" title=\"Stockout Risk\">${(item.stockout_risk_score * 100).toFixed(0)}%</span>
                            </div>
                        <div class=\"d-flex align-items-center mb-2 justify-content-between\">
                            <span class=\"badge bg-${statusColor} me-2\"><i class=\"fas ${statusIcon}\"></i> ${statusText}</span>
                            <span class=\"status-ok-badge small text-muted ms-2\">${item.days_until_stockout <= 2 ? 'âš ï¸ Immediate' : item.days_until_stockout <= 7 ? 'Soon' : 'OK'}</span>
                        </div>
                        <h5 class=\"mb-1\">${item.product_name}</h5>
                        <div class=\"location-info mb-2\">
                            <span class=\"badge bg-secondary me-2\">${item.city_name}</span>
                            <span class=\"badge bg-info\">${item.store_name}</span>
                        </div>
                        <div class=\"mb-2\">
                                <strong>Current Stock:</strong> ${item.current_stock_level} units<br>
                                <strong>Daily Demand:</strong> ${item.avg_daily_demand.toFixed(1)} units<br>
                                <strong>Days Until Stockout:</strong> ${item.days_until_stockout} days<br>
                                <strong>Stockout Frequency:</strong> ${(item.stockout_frequency * 100).toFixed(1)}%
                        </div>
                        <div class=\"mb-2\">
                            <strong>Recommended Reorder:</strong> <span class=\"badge bg-primary\">${item.recommended_reorder_quantity} units</span>
                                    </div>
                        <div class=\"mb-2\">
                            <span class=\"text-muted\">${item.last_stockout_date ? `Last stockout: ${item.last_stockout_date}` : ''}</span>
                                </div>
                        <div class=\"mini-trend mb-2\">${sparkline}</div>
                        <div class=\"animated-bar-container\">
                            <div class=\"animated-bar-bg\">
                                <div class=\"animated-bar-fill\" style=\"width: 0; background: ${barGradient};\"></div>
                            </div>
                            <span class=\"animated-bar-label text-truncate\" title=\"Stockout Risk: ${(item.stockout_risk_score * 100).toFixed(0)}%\">Stockout Risk: ${(item.stockout_risk_score * 100).toFixed(0)}%</span>
                        </div>
                    </div>
                `;
                row.appendChild(col);
                // Animate the bar after DOM insertion
                setTimeout(() => {
                    const bar = col.querySelector('.animated-bar-fill');
                    if (bar) {
                        bar.style.transition = 'width 1.2s cubic-bezier(0.4,0,0.2,1)';
                        bar.style.width = `${Math.max(5, Math.round(item.stockout_risk_score * 100))}%`;
                    }
                }, 100);
            });
            container.appendChild(row);
        }
        
        function displayDemandInsights(demandInsights) {
            const container = document.getElementById('demandInsightsContainer');
            container.innerHTML = '';
            if (!demandInsights || demandInsights.length === 0) {
                container.innerHTML = '<div class="text-center">No demand insights available</div>';
                return;
            }
            // Group by urgency
            const urgencyOrder = ['critical', 'high', 'medium', 'low'];
            urgencyOrder.forEach(level => {
                demandInsights.filter(insight => insight.urgency_level === level).forEach((insight, idx) => {
                const card = document.createElement('div');
                    card.className = `demand-alert-notification animate-in ${insight.urgency_level}`;
                card.innerHTML = `
                        <div class="d-flex align-items-center mb-2">
                            <span class="notification-icon me-2">
                                <i class="fas ${level === 'critical' ? 'fa-exclamation-triangle' : level === 'high' ? 'fa-bolt' : level === 'medium' ? 'fa-info-circle' : 'fa-check-circle'}"></i>
                            </span>
                            <span class="fw-bold me-2">${insight.location} - ${insight.store_name}</span>
                            <span class="badge bg-${level === 'critical' ? 'danger' : level === 'high' ? 'warning' : level === 'medium' ? 'info' : 'success'} ms-auto">${level.toUpperCase()}</span>
                            <button class="btn-close ms-3" aria-label="Close" onclick="dismissDemandAlert(this.closest('.demand-alert-notification'))"></button>
                        </div>
                        <div class="d-flex flex-wrap align-items-center mb-2">
                            <span class="me-3"><strong>Product:</strong> ${insight.product_name}</span>
                            <span class="me-3"><strong>Days Left:</strong> ${insight.days_until_stockout}</span>
                            <span class="me-3"><strong>Current Stock:</strong> ${insight.current_stock}</span>
                            <span class="me-3"><strong>30-Day Demand:</strong> ${insight.forecasted_demand.toFixed(0)}</span>
                            <span class="me-3"><strong>Est. Lost Sales:</strong> $${insight.estimated_lost_sales.toFixed(2)}</span>
                                </div>
                        <div class="alert-recommendation mb-2">${insight.recommended_action}</div>
                        <div class="alert-timestamp text-end text-muted small">${insight.timestamp ? `Generated: ${insight.timestamp}` : ''}</div>
                    `;
                    // Play sound on new alert
                    setTimeout(() => {
                        card.classList.add('show');
                        if (idx === 0 && level === urgencyOrder[0]) {
                            const audio = document.getElementById('demandAlertSound');
                            if (audio) { audio.currentTime = 0; audio.play(); }
                        }
                    }, 100 + idx * 80);
                    // Auto-dismiss after 8s unless hovered
                    let autoDismissTimeout;
                    function setAutoDismiss() {
                        autoDismissTimeout = setTimeout(() => {
                            dismissDemandAlert(card);
                        }, 60000); // 1 minute
                    }
                    card.addEventListener('mouseenter', () => clearTimeout(autoDismissTimeout));
                    card.addEventListener('mouseleave', setAutoDismiss);
                    setAutoDismiss();
                    // Stack at top
                    container.prepend(card);
                });
            });
        }
        // Dismiss function for alerts
        function dismissDemandAlert(card) {
            if (!card) return;
            card.classList.add('animate-out');
            setTimeout(() => card.remove(), 400);
        }
        // Real-time update placeholder
        function addDemandInsightAlert(insight) {
            // Call this function with a new insight object to add a real-time alert
            displayDemandInsights([insight]);
        }
        
        function displayInventoryRecommendations(recommendations) {
            const container = document.getElementById('recommendationsContainer');
            container.innerHTML = '';
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="text-center">No recommendations available</div>';
                return;
            }
            recommendations.forEach((rec, idx) => {
                const urgency = rec.priority || 'medium';
                let icon = 'fa-info-circle';
                if (urgency === 'critical') icon = 'fa-exclamation-triangle';
                else if (urgency === 'high') icon = 'fa-bolt';
                else if (urgency === 'medium') icon = 'fa-lightbulb';
                else if (urgency === 'low') icon = 'fa-check-circle';
                // Visual impact bar (0-100 scale, based on estimated_impact)
                const impact = Math.min(100, Math.round((rec.estimated_impact || 0) / 1000 * 100));
                const impactColor = urgency === 'critical' ? '#ff6b6b' : urgency === 'high' ? '#ffb74d' : urgency === 'medium' ? '#26c6da' : '#43a047';
                // Affected products/stores (if available)
                let affectedHtml = '';
                if (rec.affected_products || rec.affected_stores) {
                    affectedHtml = `<div class='mb-2'>`;
                    if (rec.affected_products && rec.affected_products.length) {
                        affectedHtml += `<span class='me-2'><strong>Products:</strong> </span>` +
                            rec.affected_products.map(p => `<span class='badge bg-primary me-1 mb-1'>${p}</span>`).join('');
                    }
                    if (rec.affected_stores && rec.affected_stores.length) {
                        affectedHtml += `<span class='ms-3 me-2'><strong>Stores:</strong> </span>` +
                            rec.affected_stores.map(s => `<span class='badge bg-info me-1 mb-1'>${s}</span>`).join('');
                    }
                    affectedHtml += `</div>`;
                }
                // Card
                const card = document.createElement('div');
                card.className = `recommendation-alert-card animate-in ${urgency}`;
                card.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <span class="notification-icon me-2"><i class="fas ${icon}"></i></span>
                        <span class="fw-bold me-2">${rec.title}</span>
                        <span class="badge bg-${urgency === 'critical' ? 'danger' : urgency === 'high' ? 'warning' : urgency === 'medium' ? 'info' : 'success'} ms-auto">${urgency.toUpperCase()}</span>
                        <button class="btn-close ms-3" aria-label="Close" onclick="dismissRecommendationAlert(this.closest('.recommendation-alert-card'))"></button>
                    </div>
                    ${affectedHtml}
                    <div class="mb-2"><span class="text-muted">${rec.description}</span></div>
                    <ul class="mb-2 ps-3">
                        ${(rec.action_items || []).map(item => `<li class="action-item-tooltip" title="Click for more info">${item}</li>`).join('')}
                            </ul>
                    <div class="d-flex align-items-center mb-2">
                        <div class="impact-bar-bg flex-grow-1 me-2"><div class="impact-bar-fill" style="width:${impact}%; background:${impactColor}"></div></div>
                        <span class="impact-label">Impact: $${(rec.estimated_impact || 0).toLocaleString()}</span>
                        </div>
                    <div class="text-end small text-muted">${rec.type ? rec.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}</div>
                `;
                // Animate in
                setTimeout(() => card.classList.add('show'), 100 + idx * 80);
                // Auto-dismiss after 1 min unless hovered
                let autoDismissTimeout;
                function setAutoDismiss() {
                    autoDismissTimeout = setTimeout(() => {
                        dismissRecommendationAlert(card);
                    }, 60000);
                }
                card.addEventListener('mouseenter', () => clearTimeout(autoDismissTimeout));
                card.addEventListener('mouseleave', setAutoDismiss);
                setAutoDismiss();
                // Stack at top
                container.prepend(card);
            });
        }
        // Real-time update function for recommendations
        function addInventoryRecommendationAlert(rec) {
            // Add a single new recommendation alert dynamically
            displayInventoryRecommendations([rec]);
        }
        // Dismiss function for recommendations
        function dismissRecommendationAlert(card) {
            if (!card) return;
            card.classList.add('animate-out');
            setTimeout(() => card.remove(), 400);
        }
        
        function displaySummaryStats(summary) {
            const statGrid = document.getElementById('statGrid');
            statGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${summary.total_combinations || 0}</div>
                    <div class="stat-label">Total Combinations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">$${(summary.total_predicted_sales || 0).toFixed(2)}</div>
                    <div class="stat-label">Total Predicted Sales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${(summary.avg_model_accuracy || 0).toFixed(1)}%</div>
                    <div class="stat-label">Average Accuracy</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${(summary.avg_growth_rate || 0).toFixed(1)}%</div>
                    <div class="stat-label">Average Growth Rate</div>
                </div>
            `;
        }
        
        function displayForecastChart(forecastData) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            
            if (forecastChart) {
                forecastChart.destroy();
            }
            
            // Get individual combinations for detailed breakdown
            const combinations = forecastData.combinations || [];
            
            if (!combinations.length) {
                console.error('No combination data available for chart');
                return;
            }
            
            // Create datasets for each city-store combination
            const datasets = [];
            const colors = [
                'rgb(102, 126, 234)',
                'rgb(255, 99, 132)', 
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)',
                'rgb(255, 159, 64)',
                'rgb(199, 199, 199)'
            ];
            
            // Group combinations by city-store for better visualization
            const cityStoreGroups = {};
            combinations.forEach(combo => {
                const key = `${combo.city_name} - ${combo.store_name}`;
                if (!cityStoreGroups[key]) {
                    cityStoreGroups[key] = {
                        dates: combo.forecast.dates,
                        predictions: combo.forecast.predictions,
                        city_name: combo.city_name,
                        store_name: combo.store_name,
                        product_name: combo.product_name || '',
                        total_predicted: combo.forecast.total_predicted,
                        confidence_upper: combo.forecast.confidence_upper || [],
                        confidence_lower: combo.forecast.confidence_lower || []
                    };
                } else {
                    // Sum predictions if multiple products for same city-store
                    for (let i = 0; i < combo.forecast.predictions.length; i++) {
                        cityStoreGroups[key].predictions[i] += combo.forecast.predictions[i];
                        if (cityStoreGroups[key].confidence_upper[i] && combo.forecast.confidence_upper) {
                            cityStoreGroups[key].confidence_upper[i] = Math.max(cityStoreGroups[key].confidence_upper[i], combo.forecast.confidence_upper[i]);
                        }
                        if (cityStoreGroups[key].confidence_lower[i] && combo.forecast.confidence_lower) {
                            cityStoreGroups[key].confidence_lower[i] = Math.min(cityStoreGroups[key].confidence_lower[i], combo.forecast.confidence_lower[i]);
                        }
                    }
                    cityStoreGroups[key].total_predicted += combo.forecast.total_predicted;
                }
            });
            
            // Create datasets for each city-store combination
            let colorIndex = 0;
            Object.entries(cityStoreGroups).forEach(([key, data]) => {
                datasets.push({
                    label: key,
                    data: data.predictions,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    tension: 0.4,
                    fill: false,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    product_name: data.product_name
                });
                // Add confidence intervals if available
                if (data.confidence_upper.length && data.confidence_lower.length) {
                    datasets.push({
                        label: key + ' (Upper)',
                        data: data.confidence_upper,
                        borderColor: colors[colorIndex % colors.length],
                        borderDash: [5, 5],
                        fill: '+1',
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        hidden: true // Hide in legend by default
                    });
                    datasets.push({
                        label: key + ' (Lower)',
                        data: data.confidence_lower,
                        borderColor: colors[colorIndex % colors.length],
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        hidden: true
                    });
                }
                colorIndex++;
            });
            
            // Use dates from first combination
            const dates = combinations[0].forecast.dates;
            
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    hover: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Multi-Dimensional Sales Forecast by City-Store'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const value = context.parsed.y;
                                    let label = `${dataset.label}: $${value.toFixed(2)}`;
                                    if (dataset.product_name) {
                                        label += ` | Product: ${dataset.product_name}`;
                                    }
                                    // Add confidence interval if available
                                    if (dataset.label.endsWith('(Upper)') || dataset.label.endsWith('(Lower)')) {
                                        label += ' (Confidence)';
                                    }
                                    return label;
                                },
                                afterBody: function(context) {
                                    // Optionally add more info here
                                    return '';
                                }
                            }
                        },
                        crosshair: {
                            enabled: true,
                            line: {
                                color: '#667eea',
                                width: 1
                            },
                            sync: {
                                enabled: false
                            },
                            zoom: {
                                enabled: false
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                modifierKey: 'ctrl',
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                                drag: {
                                    enabled: true
                                }
                            },
                            limits: {
                                x: { min: 0 },
                                y: { min: 0 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Sales Amount ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }
        
        // Global variables for product sales chart
        let productSalesChart = null;
        let currentForecastData = null;
        let filteredData = null;
        
        function displayProductSalesChart(forecastData) {
            currentForecastData = forecastData;
            filteredData = forecastData;
            
            // Populate filter dropdowns
            populateFilterDropdowns(forecastData);
            
            // Display default chart with all selected data
            updateProductSalesChart(forecastData);
            
            // Set up event listeners
            setupProductChartEventListeners();
        }
        
        function populateFilterDropdowns(forecastData) {
            const combinations = forecastData.combinations || [];
            
            // Extract unique products, cities, and stores
            const products = [...new Set(combinations.map(c => c.product_name).filter(Boolean))];
            const cities = [...new Set(combinations.map(c => c.city_name).filter(Boolean))];
            const stores = [...new Set(combinations.map(c => c.store_name).filter(Boolean))];
            
            // Populate product filter
            const productFilter = document.getElementById('productFilter');
            productFilter.innerHTML = '';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });
            
            // Populate city filter
            const cityFilter = document.getElementById('cityFilter');
            cityFilter.innerHTML = '';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            });
            
            // Populate store filter
            const storeFilter = document.getElementById('storeFilter');
            storeFilter.innerHTML = '';
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeFilter.appendChild(option);
            });
        }
        
        function setupProductChartEventListeners() {
            // Filter button
            document.getElementById('filterBtn').addEventListener('click', function() {
                const controls = document.getElementById('productFilterControls');
                controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
            });
            
            // View all button
            document.getElementById('viewAllBtn').addEventListener('click', function() {
                updateProductSalesChart(currentForecastData);
                document.getElementById('productFilterControls').style.display = 'none';
            });
            
            // Apply filter button
            document.getElementById('applyFilterBtn').addEventListener('click', function() {
                applyProductFilters();
            });
            
            // Reset filter button
            document.getElementById('resetFilterBtn').addEventListener('click', function() {
                resetProductFilters();
            });
        }
        
        function applyProductFilters() {
            const selectedProducts = Array.from(document.getElementById('productFilter').selectedOptions).map(opt => opt.value);
            const selectedCities = Array.from(document.getElementById('cityFilter').selectedOptions).map(opt => opt.value);
            const selectedStores = Array.from(document.getElementById('storeFilter').selectedOptions).map(opt => opt.value);
            
            let filteredCombinations = currentForecastData.combinations || [];
            
            // Apply filters
            if (selectedProducts.length > 0) {
                filteredCombinations = filteredCombinations.filter(c => selectedProducts.includes(c.product_name));
            }
            if (selectedCities.length > 0) {
                filteredCombinations = filteredCombinations.filter(c => selectedCities.includes(c.city_name));
            }
            if (selectedStores.length > 0) {
                filteredCombinations = filteredCombinations.filter(c => selectedStores.includes(c.store_name));
            }
            
            filteredData = {
                ...currentForecastData,
                combinations: filteredCombinations
            };
            
            updateProductSalesChart(filteredData);
        }
        
        function resetProductFilters() {
            document.getElementById('productFilter').selectedIndex = -1;
            document.getElementById('cityFilter').selectedIndex = -1;
            document.getElementById('storeFilter').selectedIndex = -1;
            updateProductSalesChart(currentForecastData);
        }
        
        function updateProductSalesChart(forecastData) {
            const ctx = document.getElementById('productSalesChart').getContext('2d');
            
            if (productSalesChart) {
                productSalesChart.destroy();
            }
            
            const combinations = forecastData.combinations || [];
            
            if (!combinations.length) {
                console.error('No combination data available for product sales chart');
                return;
            }
            
            // Create a bar chart showing product sales by city-store
            const labels = [];
            const datasets = [];
            const colors = [
                'rgb(102, 126, 234)',
                'rgb(255, 99, 132)', 
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)',
                'rgb(255, 159, 64)',
                'rgb(199, 199, 199)'
            ];
            
            // Group by product and calculate total sales for each city-store combination
            const productData = {};
            combinations.forEach(combo => {
                const productKey = combo.product_name || 'Unknown Product';
                const locationKey = `${combo.city_name} - ${combo.store_name}`;
                
                if (!productData[productKey]) {
                    productData[productKey] = {};
                }
                
                if (!productData[productKey][locationKey]) {
                    productData[productKey][locationKey] = 0;
                }
                
                productData[productKey][locationKey] += combo.forecast.total_predicted || 0;
            });
            
            // Create datasets for each product
            let colorIndex = 0;
            const allLocations = [...new Set(combinations.map(c => `${c.city_name} - ${c.store_name}`))];
            
            Object.entries(productData).forEach(([product, locations]) => {
                const data = [];
                
                // Create data array for all locations, filling with 0 for missing combinations
                allLocations.forEach(location => {
                    data.push(locations[location] || 0);
                });
                
                datasets.push({
                    label: product,
                    data: data,
                    backgroundColor: colors[colorIndex % colors.length].replace('rgb', 'rgba').replace(')', ', 0.8)'),
                    borderColor: colors[colorIndex % colors.length],
                    borderWidth: 1,
                    borderRadius: 4
                });
                
                colorIndex++;
            });
            
            productSalesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allLocations,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Product Sales by City-Store',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const value = context.parsed.y;
                                    return `${dataset.label}: $${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Sales Amount ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'City - Store'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        function displayInsights(insights) {
            const insightsContainer = document.getElementById('insightsContainer');
            insightsContainer.innerHTML = '';
            if (!insights || insights.length === 0) {
                insightsContainer.innerHTML = '<div class="alert alert-info text-center">No business insights available for this selection.</div>';
                return;
            }
            
            insights.forEach(insight => {
                // Determine urgency and icon
                let urgency = 'info';
                let icon = 'fa-info-circle';
                let cardClass = 'notification-info';
                if (insight.growth_rate > 10) {
                    urgency = 'success';
                    icon = 'fa-arrow-up';
                    cardClass = 'notification-success';
                } else if (insight.growth_rate < -5) {
                    urgency = 'danger';
                    icon = 'fa-arrow-down';
                    cardClass = 'notification-danger';
                } else if (insight.confidence_score < 60) {
                    urgency = 'warning';
                    icon = 'fa-exclamation-triangle';
                    cardClass = 'notification-warning';
                }

                // Notification-style card
                const notification = document.createElement('div');
                notification.className = `insight-notification ${cardClass} mb-3 p-3 rounded shadow-sm d-flex align-items-start`;
                notification.innerHTML = `
                    <div class="me-3">
                        <span class="notification-icon"><i class="fas ${icon} fa-2x"></i></span>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="text-capitalize">${insight.location} - ${insight.store_name}</strong>
                            <span class="badge bg-${urgency}">${urgency.charAt(0).toUpperCase() + urgency.slice(1)}</span>
                    </div>
                        <div class="mb-1">
                            <span class="fw-bold">${insight.product_name}</span> &mdash; <span>${insight.recommendation}</span>
                        </div>
                        <div class="mb-2 small text-muted">
                            <strong>Key Factors:</strong> ${insight.key_factors && insight.key_factors.length ? insight.key_factors.join(', ') : 'N/A'}
                        </div>
                        <div class="row g-2">
                            <div class="col-auto">
                                <span class="metric-label">Predicted Sales:</span> <span class="fw-semibold">$${insight.predicted_sales.toFixed(2)}</span>
                        </div>
                            <div class="col-auto">
                                <span class="metric-label">Growth Rate:</span> <span class="fw-semibold">${insight.growth_rate.toFixed(1)}%</span>
                    </div>
                            <div class="col-auto">
                                <span class="metric-label">Confidence:</span> <span class="fw-semibold">${insight.confidence_score.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="mt-2 small text-secondary">
                            <i class="fas fa-clock me-1"></i>Analysis generated: ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
                insightsContainer.appendChild(notification);
            });
        }
        
        function displayComparativeAnalysis(comparativeAnalysis) {
            // City comparison
            const cityComparison = document.getElementById('cityComparison');
            cityComparison.innerHTML = '';
            const storeComparison = document.getElementById('storeComparison');
            storeComparison.innerHTML = '';
            const productComparison = document.getElementById('productComparison');
            productComparison.innerHTML = '';
            const keyInsights = document.getElementById('keyInsights');
            keyInsights.innerHTML = '';

            // --- Modern Chart.js Bar Charts for Each ---
            function renderBarChart(containerId, dataObj, label, color) {
                // Remove any previous canvas
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const labels = Object.keys(dataObj);
                const values = Object.values(dataObj).map(d => d.total_predicted);
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: values,
                            backgroundColor: color,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: $${context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Total Predicted Sales ($)' }
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }

            // Render charts if data exists
            if (comparativeAnalysis.city_comparison && Object.keys(comparativeAnalysis.city_comparison).length > 0) {
                renderBarChart('cityComparison', comparativeAnalysis.city_comparison, 'City Performance', 'rgba(102,126,234,0.7)');
            }
            if (comparativeAnalysis.store_comparison && Object.keys(comparativeAnalysis.store_comparison).length > 0) {
                renderBarChart('storeComparison', comparativeAnalysis.store_comparison, 'Store Performance', 'rgba(255,99,132,0.7)');
            }
            if (comparativeAnalysis.product_comparison && Object.keys(comparativeAnalysis.product_comparison).length > 0) {
                renderBarChart('productComparison', comparativeAnalysis.product_comparison, 'Product Performance', 'rgba(54,162,235,0.7)');
            }

            // --- Key Insights as Notification Cards ---
            (comparativeAnalysis.insights || []).forEach(insight => {
                const notification = document.createElement('div');
                notification.className = 'insight-notification notification-info mb-2 p-2 rounded shadow-sm d-flex align-items-start';
                notification.innerHTML = `
                    <div class="me-2"><span class="notification-icon"><i class="fas fa-lightbulb"></i></span></div>
                    <div class="flex-grow-1">${insight}</div>
                `;
                keyInsights.appendChild(notification);
            });
        }

        // Weather and Holiday Forecasting Functions
        async function generateWeatherForecast() {
            if (selectedCities.length === 0 || selectedStores.length === 0 || selectedProducts.length === 0) {
                alert('Please select at least one city, store, and product.');
                return;
            }
            
            try {
                showLoading();
                
                const discountPercentage = parseFloat(document.getElementById('discountPercentage').value) / 100;
                const promotionDuration = parseInt(document.getElementById('promotionDuration').value);
                
                const response = await fetch('/api/weather-holiday-forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        city_ids: selectedCities.map(c => c.id),
                        store_ids: selectedStores.map(s => s.id),
                        product_ids: selectedProducts.map(p => parseInt(p.id)),
                        discount_percentage: discountPercentage,
                        promotion_duration_days: promotionDuration
                    })
                });
                
                const data = await response.json();
                weatherForecastData = data;
                
                if (data.success) {
                    displayWeatherSummary(data);
                    displayWeatherRecommendations(data.current_weather_recommendations);
                    displayHolidayAnalysis(data.holiday_impact_summary);
                    displayPromotionalAnalysis(data.promotional_analysis);
                    displayBundleRecommendations(data.bundle_recommendations);
                    displaySeasonalInsights(data.seasonal_insights);

                } else {
                    alert('Error generating weather forecast: ' + data.message);
                }
                
            } catch (error) {
                console.error('Error generating weather forecast:', error);
                alert('Error generating weather forecast. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        function showPromotionalAlert(promotionalAnalysisData) {
            const modal = new bootstrap.Modal(document.getElementById('promotionalAlertModal'));
            const content = document.getElementById('promotionalAlertContent');
            
            if (!promotionalAnalysisData || promotionalAnalysisData.length === 0) {
                content.innerHTML = '<div class="alert alert-info text-center">No promotional recommendations available at this time.</div>';
                modal.show();
                return;
            }

            let htmlContent = '';
            promotionalAnalysisData.forEach((promo, idx) => {
                const recommendationLevel = promo.recommendation.toLowerCase().includes('highly') ? 'highly-recommended' :
                                          promo.recommendation.toLowerCase().includes('recommended') ? 'recommended' :
                                          promo.recommendation.toLowerCase().includes('moderate') ? 'moderate' : 'not-recommended';
                const alertClass = getRecommendationAlertClass(recommendationLevel);
                const recommendationIcon = getRecommendationIcon(recommendationLevel);

                let cardBackgroundColor = '';
                let cardBorderLeftColor = '';

                if (recommendationLevel === 'highly-recommended') {
                    cardBackgroundColor = 'linear-gradient(90deg, #e6f9ed 0%, #fff 100%)';
                    cardBorderLeftColor = '#28a745';
                } else if (recommendationLevel === 'recommended') {
                    cardBackgroundColor = 'linear-gradient(90deg, #e0faff 0%, #fff 100%)';
                    cardBorderLeftColor = '#17a2b8';
                } else if (recommendationLevel === 'moderate') {
                    cardBackgroundColor = 'linear-gradient(90deg, #fffbe6 0%, #fff 100%)';
                    cardBorderLeftColor = '#ffc107';
                } else if (recommendationLevel === 'not-recommended') {
                    cardBackgroundColor = 'linear-gradient(90deg, #ffeaea 0%, #fff 100%)';
                    cardBorderLeftColor = '#dc3545';
                }

                const card = document.createElement('div');
                card.className = `promotional-analysis-card ${recommendationLevel} mb-3`;
                card.style.setProperty('background', cardBackgroundColor, 'important');
                card.style.setProperty('border-left', `4px solid ${cardBorderLeftColor}`, 'important');

                card.innerHTML = `
                        <div class="row">
                            <div class="col-md-9">
                                <h6>${promo.product_name} - ${promo.city_name} ${promo.store_name}</h6>
                                <div class="mb-2">
                                    <strong>Promotion:</strong> ${(promo.discount_percentage * 100).toFixed(0)}% discount for ${promo.promotion_duration_days} days
                                </div>
                                <div class="mb-2">
                                    <strong>Expected Sales Increase:</strong> <span class="text-success">${(promo.expected_sales_increase * 100).toFixed(1)}%</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Revenue Impact:</strong> 
                                    <span class="${promo.expected_revenue_impact >= 0 ? 'text-success' : 'text-danger'}">
                                        $${promo.expected_revenue_impact.toFixed(2)}
                                    </span>
                                </div>
                                <div class="small text-muted">
                                    Weather Boost: ${promo.weather_boost_factor.toFixed(2)}x | 
                                    Holiday Boost: ${promo.holiday_boost_factor.toFixed(2)}x
                                </div>
                            </div>
                            <div class="col-md-3 text-center d-flex flex-column justify-content-center align-items-center">
                                <div class="h3 mb-2">${recommendationIcon}</div>
                                <div class="fw-bold">${promo.recommendation}</div>
                                <div class="small text-muted">${promo.optimal_timing || 'Any time'}</div>
                                <div style="font-size: 0.7em; color: #888;">
                                    Debug: Lvl: ${recommendationLevel}<br>
                                    Bg: ${cardBackgroundColor.substring(0, 20)}...<br>
                                    Border: ${cardBorderLeftColor}<br>
                                    Raw Rec: ${promo.recommendation}
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="alert alert-${alertClass} py-2 mb-0">
                                ${promo.reasoning || 'No specific reasoning provided.'}
                            </div>
                        </div>
                `;
                // Animate in
                setTimeout(() => card.classList.add('show'), 100 + idx * 80);
                // Auto-dismiss after 1 min unless hovered
                let autoDismissTimeout;
                function setAutoDismiss() {
                    autoDismissTimeout = setTimeout(() => {
                        dismissPromoAlert(card);
                    }, 60000);
                }
                card.addEventListener('mouseenter', () => clearTimeout(autoDismissTimeout));
                card.addEventListener('mouseleave', setAutoDismiss);
                setAutoDismiss();
                // Stack at top
                content.prepend(card); // Prepend to add to top
            });
            
            content.innerHTML = htmlContent;
            modal.show();
        }

        function displayWeatherSummary(data) {
            const container = document.getElementById('weatherSummaryCards');
            container.innerHTML = '';
            const weatherSummary = data.weather_impact_summary;
            const holidaySummary = data.holiday_impact_summary;
            // Animated counter helper
            function animateValue(id, start, end, duration, suffix = '', decimals = 1) {
                const obj = document.getElementById(id);
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = start + (end - start) * progress;
                    obj.textContent = value.toFixed(decimals) + suffix;
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }
            // Card HTML
            const summaryCard = document.createElement('div');
            summaryCard.className = 'weather-summary-card-advanced animate-in';
            summaryCard.innerHTML = `
                <div class="row g-3 align-items-center">
                    <div class="col-6 col-md-3">
                        <div class="stat-advanced-card gradient-blue shadow-sm" title="How much sales are affected by weather patterns">
                            <div class="stat-icon-advanced"><i class="fas fa-cloud-sun"></i></div>
                            <div class="stat-value-advanced" id="weatherSensitivityStat">0%</div>
                            <div class="stat-label-advanced">Weather Sensitivity</div>
                            <div class="progress mt-2" style="height: 7px;">
                                <div class="progress-bar bg-info" id="weatherSensitivityBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-advanced-card gradient-purple shadow-sm" title="Number of cities analyzed for weather impact">
                            <div class="stat-icon-advanced"><i class="fas fa-city"></i></div>
                            <div class="stat-value-advanced" id="citiesAnalyzedStat">0</div>
                            <div class="stat-label-advanced">Cities Analyzed</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-advanced-card gradient-orange shadow-sm" title="Average sales boost during holidays">
                            <div class="stat-icon-advanced"><i class="fas fa-gift"></i></div>
                            <div class="stat-value-advanced" id="holidayBoostStat">0%</div>
                            <div class="stat-label-advanced">Holiday Boost</div>
                            <div class="progress mt-2" style="height: 7px;">
                                <div class="progress-bar bg-warning" id="holidayBoostBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-advanced-card gradient-green shadow-sm" title="Current holiday period status">
                            <div class="stat-icon-advanced"><i class="fas fa-calendar-check"></i></div>
                            <div class="stat-value-advanced" id="holidayStatusStat">-</div>
                            <div class="stat-label-advanced">Holiday Status</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(summaryCard);
            // Animate numbers and progress bars
            setTimeout(() => {
                animateValue('weatherSensitivityStat', 0, (weatherSummary.overall_weather_sensitivity * 100), 1200, '%');
                animateValue('citiesAnalyzedStat', 0, Object.keys(weatherSummary.city_weather_conditions).length, 1000, '', 0);
                animateValue('holidayBoostStat', 0, ((holidaySummary.holiday_boost_average - 1) * 100), 1200, '%');
                document.getElementById('holidayStatusStat').textContent = holidaySummary.current_holiday_status;
                document.getElementById('weatherSensitivityBar').style.width = `${(weatherSummary.overall_weather_sensitivity * 100).toFixed(1)}%`;
                document.getElementById('holidayBoostBar').style.width = `${((holidaySummary.holiday_boost_average - 1) * 100).toFixed(1)}%`;
            }, 200);
        }
        
        function displayWeatherRecommendations(recommendations) {
            const container = document.getElementById('weatherRecommendationsContainer');
            container.innerHTML = '';
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="text-center">No weather recommendations available</div>';
                return;
            }
            recommendations.forEach((rec, idx) => {
                // Determine urgency/color/icon
                let cardClass = 'weather-advanced-card gradient-blue', icon = 'fa-cloud-sun', impactColor = '#2563eb';
                if (rec.recommendation_type === 'increase_stock') { cardClass = 'weather-advanced-card gradient-green'; icon = 'fa-arrow-up'; impactColor = '#43a047'; }
                else if (rec.recommendation_type === 'decrease_stock') { cardClass = 'weather-advanced-card gradient-orange'; icon = 'fa-arrow-down'; impactColor = '#ffb74d'; }
                else if (rec.recommendation_type === 'bundle_opportunity') { cardClass = 'weather-advanced-card gradient-purple'; icon = 'fa-boxes'; impactColor = '#764ba2'; }
                // Card
                const card = document.createElement('div');
                card.className = `${cardClass} shadow-sm animate-in mb-3`;
                card.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <span class="weather-advanced-icon me-2"><i class="fas ${icon}"></i></span>
                        <span class="fw-bold me-2">${rec.product_name} <span class='badge bg-secondary ms-2'>${rec.city_name}</span> <span class='badge bg-info ms-1'>${rec.store_name}</span></span>
                        <span class="badge bg-light text-dark ms-auto">${rec.recommendation_type.replace('_', ' ').toUpperCase()}</span>
                    </div>
                    <div class="mb-2"><span class="text-muted">${rec.reasoning}</span></div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Weather:</strong> ${rec.current_weather.temperature.toFixed(1)}Â°F, ${rec.current_weather.weather_category}</div>
                        <div class="col-6"><strong>Suggested Action:</strong> <span class="badge bg-primary">${rec.suggested_stock_adjustment > 0 ? '+' : ''}${rec.suggested_stock_adjustment} units</span></div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="impact-bar-bg flex-grow-1 me-2"><div class="impact-bar-fill" id="weatherImpactBar${idx}" style="width: 0%; background:${impactColor}"></div></div>
                        <span class="impact-label">Impact: <span id="weatherImpactVal${idx}">0</span>%</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <span class="me-2"><i class="fas fa-bolt"></i> Confidence: <span id="weatherConfVal${idx}">0</span>%</span>
                    </div>
                `;
                container.appendChild(card);
                // Animate impact/confidence
                setTimeout(() => {
                    animateWeatherStat(`weatherImpactVal${idx}`, 0, rec.impact_percentage, 1000);
                    animateWeatherStat(`weatherConfVal${idx}`, 0, rec.confidence_score * 100, 1000);
                    document.getElementById(`weatherImpactBar${idx}`).style.width = `${rec.impact_percentage.toFixed(1)}%`;
                }, 200 + idx * 100);
            });
            function animateWeatherStat(id, start, end, duration) {
                const obj = document.getElementById(id);
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = start + (end - start) * progress;
                    obj.textContent = value.toFixed(1);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }
        }
        
        function displayHolidayAnalysis(holidayData) {
            const container = document.getElementById('holidayAnalysisContainer');
            container.innerHTML = '';
            
            const analysisCard = document.createElement('div');
            analysisCard.className = 'holiday-analysis-card';
            analysisCard.innerHTML = `
                <div class="mb-3">
                    <h6><i class="fas fa-calendar-check me-2"></i>Holiday Status: ${holidayData.current_holiday_status}</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar ${holidayData.holiday_boost_average > 1.1 ? 'bg-success' : holidayData.holiday_boost_average > 1.05 ? 'bg-warning' : 'bg-secondary'}" 
                             style="width: ${Math.min(100, (holidayData.holiday_boost_average - 1) * 200)}%">
                            ${((holidayData.holiday_boost_average - 1) * 100).toFixed(1)}% Boost
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-lightbulb me-2"></i>Recommendations:</h6>
                    ${holidayData.holiday_recommendations.map(rec => `
                        <div class="alert alert-info py-2 mb-2">
                            <i class="fas fa-info-circle me-2"></i>${rec}
                        </div>
                    `).join('')}
                </div>
                
                ${holidayData.holiday_sensitive_products.length > 0 ? `
                    <div>
                        <h6><i class="fas fa-star me-2"></i>Holiday-Sensitive Products:</h6>
                        ${holidayData.holiday_sensitive_products.map(product => `
                            <div class="d-flex justify-content-between align-items-center py-1">
                                <span>${product.product_name}</span>
                                <span class="badge bg-success">${((product.holiday_boost - 1) * 100).toFixed(1)}% boost</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            container.appendChild(analysisCard);
        }
        
        function displayPromotionalAnalysis(promotionalData) {
            const container = document.getElementById('promotionalAnalysisContainer');
            container.innerHTML = '';
            if (!promotionalData || promotionalData.length === 0) {
                container.innerHTML = '<div class="text-center">No promotional analysis available</div>';
                return;
            }
            promotionalData.forEach((promo, idx) => {
                // Determine recommendation level from text
                const recText = (promo.recommendation || '').toLowerCase();
                let recLevel = 'recommended';
                if (recText.includes('not recommended')) recLevel = 'not-recommended';
                else if (recText.includes('highly')) recLevel = 'highly-recommended';
                else if (recText.includes('moderate')) recLevel = 'moderate';
                // Icon and color by recommendation
                let icon = 'fa-thumbs-up', badgeColor = 'success', impactColor = '#43a047';
                if (recLevel === 'not-recommended') { icon = 'fa-thumbs-down'; badgeColor = 'danger'; impactColor = '#ff6b6b'; }
                else if (recLevel === 'moderate') { icon = 'fa-hand-paper'; badgeColor = 'warning'; impactColor = '#ffb74d'; }
                else if (recLevel === 'highly-recommended') { icon = 'fa-bolt'; badgeColor = 'primary'; impactColor = '#2563eb'; }
                // Fallback to uplift-based color if no clear recommendation
                const uplift = Math.round((promo.expected_sales_increase || 0) * 100);
                if (recLevel === 'recommended' && uplift < 10) { badgeColor = 'info'; impactColor = '#26c6da'; }
                // Card
                const card = document.createElement('div');
                card.className = `promo-alert-card animate-in ${recLevel}`;
                card.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <span class="notification-icon me-2"><i class="fas ${icon}"></i></span>
                        <span class="fw-bold me-2">${promo.product_name} <span class='badge bg-secondary ms-2'>${promo.city_name}</span> <span class='badge bg-info ms-1'>${promo.store_name}</span></span>
                        <span class="badge bg-${badgeColor} ms-auto text-uppercase">${recLevel.replace('-', ' ')}</span>
                        <button class="btn-close ms-3" aria-label="Close" onclick="dismissPromoAlert(this.closest('.promo-alert-card'))"></button>
                            </div>
                    <div class="mb-2"><span class="text-muted">${promo.recommendation}</span></div>
                    <div class="row mb-2">
                        <div class="col-6 col-md-4"><strong>Discount:</strong> ${(promo.discount_percentage * 100).toFixed(0)}%</div>
                        <div class="col-6 col-md-4"><strong>Duration:</strong> ${promo.promotion_duration_days} days</div>
                        <div class="col-12 col-md-4"><strong>Optimal Timing:</strong> ${promo.optimal_timing || 'Any time'}</div>
                            </div>
                    <div class="row mb-2">
                        <div class="col-6 col-md-4"><strong>Expected Uplift:</strong> <span class="text-success">+${uplift}%</span></div>
                        <div class="col-6 col-md-4"><strong>Revenue Impact:</strong> <span class="${promo.expected_revenue_impact >= 0 ? 'text-success' : 'text-danger'}">$${promo.expected_revenue_impact.toFixed(2)}</span></div>
                        <div class="col-12 col-md-4"><strong>Weather/Holiday Boost:</strong> <span title="Weather Boost">${promo.weather_boost_factor.toFixed(2)}x</span> / <span title="Holiday Boost">${promo.holiday_boost_factor.toFixed(2)}x</span></div>
                            </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="impact-bar-bg flex-grow-1 me-2"><div class="impact-bar-fill" style="width:${Math.min(100, uplift)}%; background:${impactColor}"></div></div>
                        <span class="impact-label">Uplift: +${uplift}%</span>
                            </div>
                    <div class="alert-reasoning mb-2">${promo.reasoning || 'No specific reasoning provided.'}</div>
                `;
                // Animate in
                setTimeout(() => card.classList.add('show'), 100 + idx * 80);
                // Auto-dismiss after 1 min unless hovered
                let autoDismissTimeout;
                function setAutoDismiss() {
                    autoDismissTimeout = setTimeout(() => {
                        dismissPromoAlert(card);
                    }, 60000);
                }
                card.addEventListener('mouseenter', () => clearTimeout(autoDismissTimeout));
                card.addEventListener('mouseleave', setAutoDismiss);
                setAutoDismiss();
                // Stack at top
                container.prepend(card);
            });
        }
        function dismissPromoAlert(card) {
            if (!card) return;
            card.classList.add('animate-out');
            setTimeout(() => card.remove(), 400);
        }
        
        function displayBundleRecommendations(bundleData) {
            const container = document.getElementById('bundleRecommendationsContainer');
            container.innerHTML = '';
            
            if (!bundleData || bundleData.length === 0) {
                container.innerHTML = '<div class="text-center">No bundle recommendations available for current weather conditions</div>';
                return;
            }
            
            bundleData.forEach(bundle => {
                const card = document.createElement('div');
                card.className = 'bundle-recommendation-card';
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6><i class="fas fa-boxes me-2"></i>${bundle.bundle_name}</h6>
                        <span class="badge bg-info">${bundle.weather_condition}</span>
                    </div>
                    <p class="mb-2">${bundle.bundle_description}</p>
                    <div class="mb-2">
                        <strong>Products:</strong>
                        ${bundle.products.map(product => `
                            <span class="badge bg-secondary me-1">${product.product_name}</span>
                        `).join('')}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>Recommended Discount:</strong> ${(bundle.recommended_discount * 100).toFixed(0)}%</small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>Expected Sales Boost:</strong> ${(bundle.expected_sales_boost * 100).toFixed(0)}%</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted"><i class="fas fa-lightbulb me-1"></i>${bundle.reasoning}</small>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function displaySeasonalInsights(seasonalData) {
            const container = document.getElementById('seasonalInsightsContainer');
            container.innerHTML = '';
            
            if (!seasonalData || seasonalData.length === 0) {
                container.innerHTML = '<div class="text-center">No seasonal insights available</div>';
                return;
            }
            
            seasonalData.forEach(insight => {
                const card = document.createElement('div');
                card.className = 'seasonal-insight-card';
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6><i class="fas fa-calendar-alt me-2"></i>${insight.season}</h6>
                        <span class="badge bg-primary">${insight.city_name}</span>
                    </div>
                    <p class="mb-2">${insight.insight}</p>
                    <div class="mb-2">
                        <strong>Expected Impact:</strong> ${insight.expected_impact}
                    </div>
                    <div>
                        <strong>Recommended Actions:</strong>
                        <ul class="mb-0 mt-1">
                            ${insight.recommended_actions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function showWeatherNotifications() {
            if (!weatherForecastData) {
                alert('Please generate weather forecast first.');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('weatherNotificationModal'));
            const content = document.getElementById('weatherNotificationContent');
            
            let notifications = [];
            
            // Generate notifications based on weather recommendations
            weatherForecastData.current_weather_recommendations.forEach(rec => {
                if (rec.recommendation_type !== 'normal') {
                    const alertClass = rec.recommendation_type === 'increase_stock' ? 'alert-success' : 
                                     rec.recommendation_type === 'decrease_stock' ? 'alert-warning' : 'alert-info';
                    
                    notifications.push({
                        type: alertClass,
                        title: `${rec.product_name} - ${rec.city_name}`,
                        message: rec.reasoning,
                        action: `Adjust stock by ${rec.suggested_stock_adjustment > 0 ? '+' : ''}${rec.suggested_stock_adjustment} units`,
                        confidence: rec.confidence_score
                    });
                }
            });
            
            // Generate notifications for promotional opportunities
            weatherForecastData.promotional_analysis.forEach(promo => {
                const recText = (promo.recommendation || '').toLowerCase();
                let alertClass = 'alert-success', icon = 'fa-thumbs-up';
                if (recText.includes('not recommended')) { alertClass = 'alert-danger'; icon = 'fa-thumbs-down'; }
                else if (recText.includes('moderate')) { alertClass = 'alert-warning'; icon = 'fa-hand-paper'; }
                else if (recText.includes('highly')) { alertClass = 'alert-primary'; icon = 'fa-bolt'; }
                    notifications.push({
                    type: alertClass,
                    icon,
                    title: `Promotion Opportunity: ${promo.product_name} (${promo.city_name}, ${promo.store_name})`,
                    message: `${(promo.discount_percentage * 100).toFixed(0)}% discount for ${promo.promotion_duration_days} days expected to increase sales by ${(promo.expected_sales_increase * 100).toFixed(1)}%` + (promo.recommendation ? ` - ${promo.recommendation}` : ''),
                        action: `Revenue impact: $${promo.expected_revenue_impact.toFixed(2)}`,
                        confidence: 0.8
                    });
            });
            
            content.innerHTML = notifications.length > 0 ? notifications.map(notification => `
                <div class="weather-alert ${notification.type}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1"><i class="fas ${notification.icon} me-2"></i>${notification.title}</h6>
                            <p class="mb-1">${notification.message}</p>
                            <small><strong>Action:</strong> ${notification.action}</small>
                        </div>
                        <div class="text-end">
                            <small>Confidence: ${(notification.confidence * 100).toFixed(0)}%</small>
                        </div>
                    </div>
                </div>
            `).join('') : '<div class="text-center">No weather alerts at this time</div>';
            
            modal.show();
        }
        
        function showProductWeatherDetail(recommendation) {
            const modal = new bootstrap.Modal(document.getElementById('productWeatherModal'));
            const content = document.getElementById('productWeatherContent');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-thermometer-half me-2"></i>Current Weather Conditions</h6>
                        <div class="weather-detail-card">
                            <div class="row">
                                <div class="col-6">
                                    <div class="weather-metric-small">
                                        <div class="value">${recommendation.current_weather.temperature.toFixed(1)}Â°F</div>
                                        <div class="label">Temperature</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="weather-metric-small">
                                        <div class="value">${recommendation.current_weather.precipitation.toFixed(1)}</div>
                                        <div class="label">Precipitation</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="weather-metric-small">
                                        <div class="value">${recommendation.current_weather.humidity.toFixed(1)}%</div>
                                        <div class="label">Humidity</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="weather-metric-small">
                                        <div class="value">${recommendation.current_weather.wind_level.toFixed(1)}</div>
                                        <div class="label">Wind Level</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line me-2"></i>Impact Analysis</h6>
                        <div class="impact-detail-card">
                            <div class="mb-3">
                                <label>Weather Category:</label>
                                <span class="badge bg-primary ms-2">${recommendation.current_weather.weather_category}</span>
                            </div>
                            <div class="mb-3">
                                <label>Recommendation:</label>
                                <span class="badge bg-${recommendation.recommendation_type === 'increase_stock' ? 'success' : recommendation.recommendation_type === 'decrease_stock' ? 'warning' : 'secondary'} ms-2">
                                    ${recommendation.recommendation_type.replace('_', ' ')}
                                </span>
                            </div>
                            <div class="mb-3">
                                <label>Expected Impact:</label>
                                <span class="ms-2">${recommendation.impact_percentage.toFixed(1)}%</span>
                            </div>
                            <div class="mb-3">
                                <label>Stock Adjustment:</label>
                                <span class="ms-2">${recommendation.suggested_stock_adjustment > 0 ? '+' : ''}${recommendation.suggested_stock_adjustment} units</span>
                            </div>
                            <div class="mb-3">
                                <label>Confidence Score:</label>
                                <span class="ms-2">${(recommendation.confidence_score * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6><i class="fas fa-lightbulb me-2"></i>Detailed Reasoning</h6>
                        <div class="alert alert-info">
                            ${recommendation.reasoning}
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }
        
        // Helper functions
        function getWeatherIcon(weatherCategory) {
            const icons = {
                'cold': '<i class="fas fa-snowflake text-primary"></i>',
                'warm': '<i class="fas fa-sun text-warning"></i>',
                'rainy': '<i class="fas fa-cloud-rain text-info"></i>',
                'dry': '<i class="fas fa-sun text-warning"></i>',
                'mild': '<i class="fas fa-cloud-sun text-secondary"></i>'
            };
            return icons[weatherCategory] || '<i class="fas fa-cloud text-secondary"></i>';
        }
        
        function getImpactIcon(recommendationType) {
            const icons = {
                'increase_stock': '<i class="fas fa-arrow-up text-success"></i>',
                'decrease_stock': '<i class="fas fa-arrow-down text-danger"></i>',
                'normal': '<i class="fas fa-minus text-secondary"></i>',
                'bundle_opportunity': '<i class="fas fa-gift text-warning"></i>'
            };
            return icons[recommendationType] || '<i class="fas fa-minus text-secondary"></i>';
        }
        
        function getRecommendationIcon(level) {
            const icons = {
                'highly-recommended': '<i class="fas fa-arrow-alt-circle-up text-success !important"></i>',
                'recommended': '<i class="fas fa-check-circle text-info !important"></i>',
                'moderate': '<i class="fas fa-exclamation-circle text-warning !important"></i>',
                'not-recommended': '<i class="fas fa-times-circle text-danger !important"></i>'
            };
            return icons[level] || '<i class="fas fa-question-circle text-secondary !important"></i>';
        }
        
        function getRecommendationAlertClass(level) {
            const classes = {
                'highly-recommended': 'success',
                'recommended': 'info',
                'moderate': 'warning',
                'not-recommended': 'danger'
            };
            return classes[level] || 'secondary';
        }

        // --- Clustering & Segmentation Logic ---
        async function runStoreClustering() {
            await runClustering('stores', 'storeClusteringAlgorithm', 'storeClusteringFeatures', 'storeClusteringNClusters', 'storeClusteringResults');
        }
        async function runProductClustering() {
            await runClustering('products', 'productClusteringAlgorithm', 'productClusteringFeatures', 'productClusteringNClusters', 'productClusteringResults');
        }
        async function runCityClustering() {
            await runClustering('cities', 'cityClusteringAlgorithm', 'cityClusteringFeatures', 'cityClusteringNClusters', 'cityClusteringResults');
        }
        async function runClustering(entityType, algoId, featuresId, nClustersId, resultsId) {
            const algorithm = document.getElementById(algoId).value;
            const features = Array.from(document.getElementById(featuresId).selectedOptions).map(opt => opt.value);
            const n_clusters = parseInt(document.getElementById(nClustersId).value);
            const resultsDiv = document.getElementById(resultsId);
            resultsDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p>Running clustering analysis...</p></div>';
            try {
                const res = await fetch('/api/cluster-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_type: entityType,
                        clustering_algorithm: algorithm,
                        n_clusters: n_clusters,
                        features: features
                    })
                });
                if (!res.ok) throw new Error('Clustering failed');
                const data = await res.json();
                renderClusteringResults(data, resultsDiv);
            } catch (err) {
                resultsDiv.innerHTML = `<div class='alert alert-danger'>Error: ${err.message}</div>`;
            }
        }
        function renderClusteringResults(data, container) {
            if (!data.success) {
                container.innerHTML = `<div class='alert alert-danger'>Clustering failed: ${data.detail || 'Unknown error'}</div>`;
                return;
            }
            let html = '';
            // Build a mapping from cluster_id to profile for tooltips
            const clusterProfileMap = {};
            data.cluster_profiles.forEach(profile => {
                clusterProfileMap[profile.cluster_id] = profile;
            });
            // --- Stat Cards for Quality Metrics ---
            html += `<div class='row mb-4'>`;
            const pastelColors = [
                'linear-gradient(135deg, #e0ffe7 0%, #f8fafc 100%)',
                'linear-gradient(135deg, #e3f0ff 0%, #f8fafc 100%)',
                'linear-gradient(135deg, #fffbe7 0%, #f8fafc 100%)',
                'linear-gradient(135deg, #f1f5fa 0%, #f8fafc 100%)',
                'linear-gradient(135deg, #ffeaea 0%, #f8fafc 100%)',
            ];
            Object.entries(data.cluster_quality_metrics).forEach(([k, v], idx) => {
                html += `
                <div class='col-md-3 mb-3'>
                    <div class='stat-advanced-card shadow' style='background: ${pastelColors[idx % pastelColors.length]}; min-height: 110px;'>
                        <div class='d-flex align-items-center'>
                            <div class='me-3 display-6'><i class='fas fa-chart-line'></i></div>
                            <div>
                                <div class='stat-label text-uppercase' style='font-size: 0.9rem;'>${k.replace(/_/g, ' ')}</div>
                                <div class='stat-value fw-bold' style='font-size: 1.5rem;' data-animate-number='${typeof v === 'number' ? v.toFixed(3) : v}'>${typeof v === 'number' ? v.toFixed(3) : v}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            // --- Insights as Notification Cards ---
            if (data.insights && data.insights.length) {
                html += `<div class='row mb-4'>` + data.insights.map(i => `
                    <div class='col-md-6 mb-2'>
                        <div class='alert alert-info animate-in insight-notification'><i class='fas fa-lightbulb me-2'></i>${i}</div>
                    </div>`).join('') + `</div>`;
            }
            // --- Cluster Profiles as Animated Cards ---
            html += `<h5 class='mb-2 mt-3'><i class='fas fa-layer-group me-2'></i>Cluster Profiles</h5><div class='row'>`;
            data.cluster_profiles.forEach((profile, idx) => {
                const grad = pastelColors[idx % pastelColors.length];
                // Compose a user-friendly description for the cluster
                let desc = profile.description || '';
                if (!desc) {
                    // Try to infer a description from key metrics
                    const keys = Object.keys(profile.key_metrics).map(k => k.toLowerCase());
                    if (keys.includes('total revenue mean') || keys.includes('avg sales')) {
                        desc = 'High Revenue Stores: These stores have the highest sales and customer traffic.';
                    } else if (keys.includes('stockout frequency mean')) {
                        desc = 'Stockout-Prone Stores: These stores frequently run out of stock.';
                    } else if (keys.includes('promotion effectiveness')) {
                        desc = 'Promotion-Responsive Stores: These stores respond well to promotions.';
                    } else {
                        desc = 'Stores grouped by similar performance and behavior.';
                    }
                }
                html += `<div class='col-md-4 mb-3'>
                    <div class='stat-advanced-card shadow h-100' style='background: ${grad}; min-height: 180px;'>
                        <div class='d-flex align-items-center mb-2'>
                            <div class='me-3 display-6'><i class='fas fa-users'></i></div>
                            <div>
                                <div class='fw-bold' style='font-size: 1.1rem;'>${profile.cluster_name} <span class='badge bg-info ms-1'>Cluster ${profile.cluster_id}</span></div>
                                <div class='text-muted' style='font-size: 0.97rem;'>${desc}</div>
                                <div class='text-white-50' style='font-size: 0.9rem;'>Entities: ${profile.entity_count}</div>
                            </div>
                        </div>
                        <ul class='mb-2' style='color: #22223b;'>`;
                for (const [k, v] of Object.entries(profile.key_metrics)) {
                    html += `<li><span class='fw-bold'>${k.replace(/_/g, ' ')}:</span> ${typeof v === 'number' ? v.toFixed(2) : v}</li>`;
                }
                html += `</ul>`;
                if (profile.representative_entities && profile.representative_entities.length) {
                    html += `<div class='mt-2'><span class='badge bg-light text-dark'>Examples:</span> ` + profile.representative_entities.map(e => `<span class='badge bg-dark ms-1'>${e.name}</span>`).join('') + `</div>`;
                }
                html += `</div></div>`;
            });
            html += `</div>`;
            // --- Entity Assignments Table (Animated, with tooltips) ---
            html += `<h5 class='mb-2 mt-3'><i class='fas fa-table me-2'></i>Entity Assignments</h5><div class='table-responsive mb-4' style='max-height:350px;overflow:auto;'><table class='table table-sm table-bordered align-middle animated-table'><thead class='table-light'><tr>`;
            if (data.entity_assignments.length) {
                Object.keys(data.entity_assignments[0]).forEach(k => {
                    html += `<th>${k.replace(/_/g, ' ')}</th>`;
                });
            }
            html += `</tr></thead><tbody>`;
            data.entity_assignments.forEach((e, rowIdx) => {
                html += `<tr class='fade-in-row' style='animation-delay:${rowIdx * 0.04}s;'>`;
                Object.entries(e).forEach(([k, v]) => {
                    if (k === 'cluster_id' && clusterProfileMap[v]) {
                        // Add info icon with tooltip for cluster description
                        html += `<td><span class='badge bg-primary'>${v}</span> <span class='ms-1' data-bs-toggle='tooltip' title='${clusterProfileMap[v].description || clusterProfileMap[v].cluster_name}'>
                            <i class='fas fa-info-circle text-info'></i></span></td>`;
                    } else if (typeof v === 'number') {
                        html += `<td><span class='badge bg-primary'>${v.toFixed(2)}</span></td>`;
                    } else if (typeof v === 'string' && v.length < 20) {
                        html += `<td><span class='badge bg-secondary'>${v}</span></td>`;
                    } else {
                        html += `<td>${v}</td>`;
                    }
                });
                html += `</tr>`;
            });
            html += `</tbody></table></div>`;
            // --- Recommendations as Notification Cards ---
            if (data.recommendations && data.recommendations.length) {
                html += `<h5 class='mb-2 mt-3'><i class='fas fa-bolt me-2'></i>Recommendations</h5><div class='row'>` + data.recommendations.map((r, idx) => {
                    const alertColors = ['success','info','warning','danger','primary'];
                    return `<div class='col-md-6 mb-2'><div class='alert alert-${alertColors[idx % alertColors.length]} animate-in'><i class='fas fa-robot me-2'></i><b>${r.title || r.action || r.recommendation_type}:</b> ${r.description || r.reason || ''} <span class='text-muted'>${r.expected_impact ? 'Impact: ' + r.expected_impact : ''}</span></div></div>`;
                }).join('') + `</div>`;
            }
            container.innerHTML = html;
            // Animate numbers
            setTimeout(() => {
                document.querySelectorAll('[data-animate-number]').forEach(el => {
                    const end = parseFloat(el.getAttribute('data-animate-number'));
                    let start = 0;
                    const duration = 900;
                    const step = (timestamp, startTimestamp) => {
                        if (!startTimestamp) startTimestamp = timestamp;
                        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                        const value = start + (end - start) * progress;
                        el.textContent = value.toFixed(3);
                        if (progress < 1) {
                            window.requestAnimationFrame(ts => step(ts, startTimestamp));
                        }
                    };
                    window.requestAnimationFrame(step);
                });
            }, 200);
            // After rendering, enable Bootstrap tooltips
            setTimeout(() => {
                if (window.bootstrap && window.bootstrap.Tooltip) {
                    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                        new window.bootstrap.Tooltip(el);
                    });
                }
            }, 300);
        }

        function updateSelectedDisplay(containerId, items, removeFunction) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach((item, index) => {
                const span = document.createElement('span');
                span.className = 'selected-item';
                span.textContent = item.name;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Ã—';
                removeBtn.addEventListener('click', () => removeFunction(index));

                span.appendChild(removeBtn);
                container.appendChild(span);
            });
        }
        window.updateSelectedDisplay = updateSelectedDisplay;

        // --- Real-time Inventory Recommendations Polling ---
        let inventoryRecPollingInterval = null;

        function startInventoryRecommendationPolling() {
            // Initial fetch
            // fetchAndDisplayInventoryRecommendations(); // Removed to prevent immediate execution
            // Set interval for periodic updates (every 30 seconds)
            // inventoryRecPollingInterval = setInterval(fetchAndDisplayInventoryRecommendations, 30000); // Removed to prevent continuous polling
        }

        function stopInventoryRecommendationPolling() {
            // clearInterval(inventoryRecPollingInterval); // Removed to match removal of setInterval
            // inventoryRecPollingInterval = null;
        }

        async function fetchAndDisplayInventoryRecommendations() {
            // Use your current selection variables
            const cityIds = (typeof selectedCities !== 'undefined') ? selectedCities.map(c => c.id) : [];
            const storeIds = (typeof selectedStores !== 'undefined') ? selectedStores.map(s => s.id) : [];
            const productIds = (typeof selectedProducts !== 'undefined') ? selectedProducts.map(p => parseInt(p.id)) : [];
            if (!cityIds.length || !storeIds.length || !productIds.length) {
                displayInventoryRecommendations([]);
                return;
            }
            try {
                const response = await fetch('/api/demand-forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city_ids: cityIds,
                        store_ids: storeIds,
                        product_ids: productIds,
                        forecast_days: 30 // or your current value
                    })
                });
                if (!response.ok) throw new Error('Failed to fetch recommendations');
                const data = await response.json();
                displayInventoryRecommendations(data.inventory_recommendations || []);
            } catch (err) {
                console.error('Error fetching inventory recommendations:', err);
            }
        }
        // --- End Real-time Polling ---

        // --- Hook polling to selection changes ---
        // Call startInventoryRecommendationPolling() whenever selection changes
        // For example, after addCity, addStore, addProduct, removeCity, removeStore, removeProduct
        window._origAddCity = window.addCity;
        window.addCity = function() { window._origAddCity.apply(this, arguments); startInventoryRecommendationPolling(); };
        window._origAddStore = window.addStore;
        window.addStore = function() { window._origAddStore.apply(this, arguments); startInventoryRecommendationPolling(); };
        window._origAddProduct = window.addProduct;
        window.addProduct = function() { window._origAddProduct.apply(this, arguments); startInventoryRecommendationPolling(); };
        window._origRemoveCity = window.removeCity;
        window.removeCity = function() { window._origRemoveCity.apply(this, arguments); startInventoryRecommendationPolling(); };
        window._origRemoveStore = window.removeStore;
        window.removeStore = function() { window._origRemoveStore.apply(this, arguments); startInventoryRecommendationPolling(); };
        window._origRemoveProduct = window.removeProduct;
        window.removeProduct = function() { window._origRemoveProduct.apply(this, arguments); startInventoryRecommendationPolling(); };
        // --- End Hook ---

        // --- Real-time Demand Insights & Alerts Polling ---
        let demandInsightsPollingInterval = null;

        function startDemandInsightsPolling() {
            // Initial fetch
            // fetchAndDisplayDemandInsights(); // Removed to prevent immediate execution
            // Set interval for periodic updates (every 30 seconds)
            // demandInsightsPollingInterval = setInterval(fetchAndDisplayDemandInsights, 30000); // Removed to prevent continuous polling
        }

        function stopDemandInsightsPolling() {
            // clearInterval(demandInsightsPollingInterval); // Removed to match removal of setInterval
            // demandInsightsPollingInterval = null;
        }

        async function fetchAndDisplayDemandInsights() {
            const cityIds = (typeof selectedCities !== 'undefined') ? selectedCities.map(c => c.id) : [];
            const storeIds = (typeof selectedStores !== 'undefined') ? selectedStores.map(s => s.id) : [];
            const productIds = (typeof selectedProducts !== 'undefined') ? selectedProducts.map(p => parseInt(p.id)) : [];
            if (!cityIds.length || !storeIds.length || !productIds.length) {
                displayDemandInsights([]);
                return;
            }
            try {
                const response = await fetch('/api/demand-forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city_ids: cityIds,
                        store_ids: storeIds,
                        product_ids: productIds,
                        forecast_days: 30
                    })
                });
                if (!response.ok) throw new Error('Failed to fetch demand insights');
                const data = await response.json();
                displayDemandInsights(data.demand_insights || []);
            } catch (err) {
                console.error('Error fetching demand insights:', err);
            }
        }
        // --- End Real-time Polling ---

        // --- Hook polling to selection changes ---
        window._origAddCity_DI = window.addCity;
        window.addCity = function() { window._origAddCity_DI.apply(this, arguments); startDemandInsightsPolling(); };
        window._origAddStore_DI = window.addStore;
        window.addStore = function() { window._origAddStore_DI.apply(this, arguments); startDemandInsightsPolling(); };
        window._origAddProduct_DI = window.addProduct;
        window.addProduct = function() { window._origAddProduct_DI.apply(this, arguments); startDemandInsightsPolling(); };
        window._origRemoveCity_DI = window.removeCity;
        window.removeCity = function() { window._origRemoveCity_DI.apply(this, arguments); startDemandInsightsPolling(); };
        window._origRemoveStore_DI = window.removeStore;
        window.removeStore = function() { window._origRemoveStore_DI.apply(this, arguments); startDemandInsightsPolling(); };
        window._origRemoveProduct_DI = window.removeProduct;
        window.removeProduct = function() { window._origRemoveProduct_DI.apply(this, arguments); startDemandInsightsPolling(); };
        // --- End Hook ---

        // Advanced Store Clustering UI (replace or enhance updateClusteringUI)
        function updateClusteringUI(data) {
            const storeName = document.getElementById('storeSelect').options[document.getElementById('storeSelect').selectedIndex].text;
            document.getElementById('clustering-summary').textContent = 
                `Store clustering analysis for ${storeName} showing behavioral patterns and performance characteristics.`;
            // Advanced Quality Metrics
            if (data.quality_metrics) {
                const qm = data.quality_metrics;
                const metricsRow = document.createElement('div');
                metricsRow.className = 'row g-3 mb-3 clustering-quality-advanced animate-in';
                metricsRow.innerHTML = `
                    <div class="col-6 col-md-2"><div class="stat-advanced-card gradient-blue shadow-sm" title="Silhouette Score"><div class="stat-icon-advanced"><i class="fas fa-project-diagram"></i></div><div class="stat-value-advanced" id="qmSilhouette">0</div><div class="stat-label-advanced">Silhouette</div></div></div>
                    <div class="col-6 col-md-2"><div class="stat-advanced-card gradient-purple shadow-sm" title="Calinski-Harabasz Score"><div class="stat-icon-advanced"><i class="fas fa-chart-bar"></i></div><div class="stat-value-advanced" id="qmCH">0</div><div class="stat-label-advanced">Calinski-Harabasz</div></div></div>
                    <div class="col-6 col-md-2"><div class="stat-advanced-card gradient-orange shadow-sm" title="Inertia"><div class="stat-icon-advanced"><i class="fas fa-bullseye"></i></div><div class="stat-value-advanced" id="qmInertia">0</div><div class="stat-label-advanced">Inertia</div></div></div>
                    <div class="col-6 col-md-2"><div class="stat-advanced-card gradient-green shadow-sm" title="Avg Cluster Size"><div class="stat-icon-advanced"><i class="fas fa-users"></i></div><div class="stat-value-advanced" id="qmAvgSize">0</div><div class="stat-label-advanced">Avg Size</div></div></div>
                    <div class="col-6 col-md-2"><div class="stat-advanced-card gradient-teal shadow-sm" title="Cluster Size Stddev"><div class="stat-icon-advanced"><i class="fas fa-chart-area"></i></div><div class="stat-value-advanced" id="qmStdSize">0</div><div class="stat-label-advanced">Size Stddev</div></div></div>
                    <div class="col-6 col-md-2"><div class="stat-advanced-card gradient-red shadow-sm" title="Min/Max Cluster Size"><div class="stat-icon-advanced"><i class="fas fa-sort-numeric-up"></i></div><div class="stat-value-advanced" id="qmMinMaxSize">0/0</div><div class="stat-label-advanced">Min/Max Size</div></div></div>
                `;
                const parent = document.getElementById('storeClusteringResults');
                parent.innerHTML = '';
                parent.appendChild(metricsRow);
                setTimeout(() => {
                    document.getElementById('qmSilhouette').textContent = qm.silhouette_score.toFixed(3);
                    document.getElementById('qmCH').textContent = qm.calinski_harabasz_score.toFixed(3);
                    document.getElementById('qmInertia').textContent = qm.inertia.toFixed(3);
                    document.getElementById('qmAvgSize').textContent = qm.avg_cluster_size.toFixed(2);
                    document.getElementById('qmStdSize').textContent = qm.cluster_size_std.toFixed(2);
                    document.getElementById('qmMinMaxSize').textContent = `${qm.min_cluster_size.toFixed(0)}/${qm.max_cluster_size.toFixed(0)}`;
                }, 200);
            }
            // Summary
            if (data.summary) {
                const summaryCard = document.createElement('div');
                summaryCard.className = 'stat-advanced-card gradient-blue shadow-sm animate-in mb-3';
                summaryCard.innerHTML = `<div class='stat-icon-advanced'><i class='fas fa-info-circle'></i></div><div class='stat-label-advanced mb-2'>${data.summary}</div>`;
                document.getElementById('storeClusteringResults').appendChild(summaryCard);
            }
            // Cluster Profiles
            if (data.cluster_profiles && Array.isArray(data.cluster_profiles)) {
                const profilesRow = document.createElement('div');
                profilesRow.className = 'row g-3 mb-3';
                data.cluster_profiles.forEach((profile, idx) => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4';
                    card.innerHTML = `<div class='stat-advanced-card gradient-purple shadow-sm animate-in' title='${profile.cluster_name} Profile'><div class='stat-icon-advanced'><i class='fas fa-layer-group'></i></div><div class='stat-value-advanced'>${profile.cluster_name}</div><div class='stat-label-advanced'>Entities: ${profile.entity_count}</div><ul class='mb-0 mt-2'>${Object.entries(profile.key_metrics).map(([k, v]) => `<li><strong>${k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${typeof v === 'number' ? v.toFixed(2) : v}</li>`).join('')}</ul></div>`;
                    profilesRow.appendChild(card);
                });
                document.getElementById('storeClusteringResults').appendChild(profilesRow);
            }
            // Entity Assignments
            if (data.entity_assignments && Array.isArray(data.entity_assignments)) {
                const table = document.createElement('table');
                table.className = 'table table-hover table-striped animate-in';
                table.innerHTML = `<thead><tr><th>Entity ID</th><th>Name</th><th>Cluster</th><th>Cluster Name</th><th>Similarity</th><th>Key Attributes</th></tr></thead><tbody>${data.entity_assignments.map(entity => `<tr><td>${entity.entity_id}</td><td>${entity.entity_name}</td><td><span class='badge bg-primary'>${entity.cluster_id}</span></td><td>${entity.cluster_name}</td><td><span class='badge bg-info'>${(entity.similarity_score * 100).toFixed(1)}%</span></td><td>${Object.entries(entity.key_attributes).map(([key, value]) => `<span class='badge bg-secondary me-1'>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: ${typeof value === 'number' ? value.toFixed(2) : value}</span>`).join('')}</td></tr>`).join('')}</tbody>`;
                document.getElementById('storeClusteringResults').appendChild(table);
            }
            // Recommendations
            if (data.recommendations && Array.isArray(data.recommendations)) {
                const recsRow = document.createElement('div');
                recsRow.className = 'row g-2 mt-3';
                data.recommendations.forEach(rec => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6';
                    card.innerHTML = `<div class='alert alert-success animate-in'><i class='fas fa-check-circle me-2'></i>${rec}</div>`;
                    recsRow.appendChild(card);
                });
                document.getElementById('storeClusteringResults').appendChild(recsRow);
            }
        }

        // WebSocket for real-time notifications
        let ws = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws_url = `${protocol}//${window.location.host}/ws`;
            ws = new WebSocket(ws_url);

            ws.onopen = (event) => {
                console.log("WebSocket connected!", event);
            };

            ws.onmessage = (event) => {
                console.log("WebSocket message received:", event.data);
                showNotification(event.data);
            };

            ws.onclose = (event) => {
                console.log("WebSocket disconnected:", event);
                // Attempt to reconnect after a delay
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
                ws.close();
            };
        }

        function showNotification(message) {
            const notificationContainer = document.getElementById('notificationContainer');
            const notificationId = `notification-${Date.now()}`;
            let alertClass = 'alert-info'; // Default
            let iconClass = 'fas fa-info-circle';

            if (message.includes("successfully") || message.includes("complete")) {
                alertClass = 'alert-success';
                iconClass = 'fas fa-check-circle';
            } else if (message.includes("failed") || message.includes("error") || message.includes("Alert")) {
                alertClass = 'alert-danger';
                iconClass = 'fas fa-exclamation-circle';
            } else if (message.includes("Insight") || message.includes("Analyzing")) {
                alertClass = 'alert-primary'; // Use primary for insights
                iconClass = 'fas fa-lightbulb';
            } else if (message.includes("Getting") || message.includes("Fetching") || message.includes("Generating")) {
                alertClass = 'alert-info';
                iconClass = 'fas fa-sync-alt';
            }

            const notificationHtml = `
                <div id="${notificationId}" class="alert ${alertClass} alert-dismissible fade show animate-in" role="alert" style="width: 350px;">
                    <i class="${iconClass} me-2"></i>
                    ${message.replace("Notification: ", "").replace("Insight for Sales Forecast: ", "Insight: ").replace("Alert for Demand Forecast: ", "Alert: ")}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            const newNotification = document.createElement('div');
            newNotification.innerHTML = notificationHtml;
            notificationContainer.prepend(newNotification); // Add to top

            // Auto-hide after 10 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(notificationId);
                if (alertElement) {
                    alertElement.classList.remove('show');
                    alertElement.classList.add('animate-out');
                    alertElement.addEventListener('animationend', () => alertElement.remove());
                }
            }, 10000);
        }
    </script>
    <!-- Ensure global scope for addCity and related functions -->
    <script>
        window.addCity = addCity;
        window.removeCity = removeCity;
        window.addStore = addStore;
        window.removeStore = removeStore;
        window.addProduct = addProduct;
        window.removeProduct = removeProduct;
    </script>
    <!-- Add sound for notifications -->
    <audio id="demandAlertSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae1e2.mp3" preload="auto"></audio>
</body>
</html>