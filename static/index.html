<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Sales Forecasting</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <link href="/static/lib/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }
        .small-chart-container {
            height: 200px;
            margin-top: 1rem;
        }
        .result-section {
            display: none;
            margin-top: 1.5rem;
        }
        .tab-content {
            padding: 1.5rem;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.25rem 0.25rem;
        }
        .risk-meter {
            width: 100%;
            height: 30px;
            background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
            border-radius: 15px;
            position: relative;
            margin: 1rem 0;
        }
        .risk-indicator {
            width: 20px;
            height: 20px;
            background-color: #000;
            border-radius: 50%;
            position: absolute;
            top: 5px;
            transform: translateX(-50%);
        }
        .recommendation-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 1rem;
        }
        .cluster-card {
            border-left: 4px solid #28a745;
            margin-bottom: 1rem;
        }
        .weather-card {
            border-left: 4px solid #ffc107;
            margin-bottom: 1rem;
        }
        .category-card {
            border-left: 4px solid #dc3545;
            margin-bottom: 1rem;
        }
        .custom-select-container {
            margin-bottom: 1rem;
        }
        .metric-card {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .weather-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .cluster-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            color: white;
            margin: 0.25rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-4 text-center">
            <h1 class="display-4">Retail Sales Forecasting</h1>
            <p class="lead">Analyze sales data, predict trends, and optimize inventory with advanced AI models</p>
        </header>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Input Parameters</h5>
                    </div>
                    <div class="card-body">
                        <form id="forecast-form">
                            <div class="mb-3">
                                <label for="citySelect" class="form-label">City</label>
                                <select class="form-select" id="citySelect" required>
                                    <option value="" disabled>Select city</option>
                                    <option value="0" selected>New York, NY</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="storeSelect" class="form-label">Store</label>
                                <select class="form-select" id="storeSelect" required>
                                    <option value="" disabled>Select store</option>
                                    <option value="0" selected>Downtown Market</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="productSelect" class="form-label">Product</label>
                                <select class="form-select" id="productSelect" required>
                                    <option value="" disabled>Select product</option>
                                    <option value="4">Fresh Apples</option>
                                    <option value="6">Organic Milk</option>
                                    <option value="18">Whole Wheat Bread</option>
                                    <option value="19">Sparkling Water</option>
                                    <option value="21" selected>Premium Coffee</option>
                                    <option value="23">Fresh Bananas</option>
                                    <option value="26">Organic Eggs</option>
                                    <option value="38">Fresh Tomatoes</option>
                                    <option value="41">Organic Yogurt</option>
                                    <option value="70">Fresh Lettuce</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="categorySelect" class="form-label">Category</label>
                                <select class="form-select" id="categorySelect">
                                    <option value="" disabled selected>Select category</option>
                                    <option value="1">Fresh Produce</option>
                                    <option value="2">Dairy Products</option>
                                    <option value="3">Beverages</option>
                                    <option value="4">Bakery</option>
                                    <option value="5">Organic</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="forecastDays" class="form-label">Forecast Days</label>
                                <input type="range" class="form-range" min="7" max="60" step="1" value="30" id="forecastDays">
                                <div class="d-flex justify-content-between">
                                    <span>7 days</span>
                                    <span id="daysValue">30 days</span>
                                    <span>60 days</span>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Generate Analysis</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">API Documentation</h5>
                    </div>
                    <div class="card-body">
                        <p>Access our API directly:</p>
                        <ul>
                            <li><a href="/docs" target="_blank">Interactive API Docs</a></li>
                            <li><a href="/api/forecast/0/0/38" target="_blank">Sample Forecast</a></li>
                            <li><a href="/api/promotions/impact/0/38" target="_blank">Sample Promotion Analysis</a></li>
                            <li><a href="/api/stockout/risk/0/38" target="_blank">Sample Stockout Risk</a></li>
                            <li><a href="/api/weather/analyze" target="_blank">Weather Analysis</a></li>
                            <li><a href="/api/category/performance" target="_blank">Category Analysis</a></li>
                            <li><a href="/api/stores/cluster" target="_blank">Store Clustering</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div id="loading" class="text-center p-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading analysis data...</p>
                </div>

                <div id="results" class="result-section">
                    <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast" type="button" role="tab" onclick="showTab('forecast')">Sales Forecast</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="promotions-tab" data-bs-toggle="tab" data-bs-target="#promotions" type="button" role="tab" onclick="showTab('promotions')">Promotions</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stockout-tab" data-bs-toggle="tab" data-bs-target="#stockout" type="button" role="tab" onclick="showTab('stockout')">Stockout Risk</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="weather-tab" data-bs-toggle="tab" data-bs-target="#weather" type="button" role="tab" onclick="showTab('weather')">Weather Impact</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab" onclick="showTab('category')">Category Analysis</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="clustering-tab" data-bs-toggle="tab" data-bs-target="#clustering" type="button" role="tab" onclick="showTab('clustering')">Store Clustering</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="analysisTabContent">
                        <!-- Existing tabs -->
                        <div class="tab-pane fade show active" id="forecast" role="tabpanel">
                            <h4>Sales Forecast</h4>
                            <p id="forecast-summary" class="lead"></p>
                            <div class="chart-container">
                                <canvas id="forecastChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="promotions" role="tabpanel">
                            <h4>Promotion Impact Analysis</h4>
                            <p id="promotion-summary" class="lead"></p>
                            <h5 class="mt-4">Recommendations</h5>
                            <div id="promotion-recommendations"></div>
                        </div>
                        
                        <div class="tab-pane fade" id="stockout" role="tabpanel">
                            <h4>Stockout Risk Assessment</h4>
                            <p id="stockout-summary" class="lead"></p>
                            
                            <div class="card mt-3">
                                <div class="card-body">
                                    <h5>Risk Score</h5>
                                    <div class="risk-meter">
                                        <div class="risk-indicator" id="risk-indicator"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Low</span>
                                        <span>Medium</span>
                                        <span>High</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Risk Factors</h5>
                                            <div id="risk-factors"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Recommended Stock Levels</h5>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Min</th>
                                                            <th>Target</th>
                                                            <th>Max</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="stock-levels"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Weather-Sensitive Demand Tab -->
                        <div class="tab-pane fade" id="weather" role="tabpanel">
                            <h4>Weather-Sensitive Demand Analysis</h4>
                            <p id="weather-summary" class="lead"></p>
                            
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <div class="card weather-card">
                                        <div class="card-body metric-card">
                                            <div class="weather-icon">üå°Ô∏è</div>
                                            <div class="metric-value" id="temp-impact">--</div>
                                            <div class="metric-label">Temperature Impact</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card weather-card">
                                        <div class="card-body metric-card">
                                            <div class="weather-icon">üíß</div>
                                            <div class="metric-value" id="humidity-impact">--</div>
                                            <div class="metric-label">Humidity Impact</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card weather-card">
                                        <div class="card-body metric-card">
                                            <div class="weather-icon">üåßÔ∏è</div>
                                            <div class="metric-value" id="rain-impact">--</div>
                                            <div class="metric-label">Rain Impact</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card weather-card">
                                        <div class="card-body metric-card">
                                            <div class="weather-icon">üå™Ô∏è</div>
                                            <div class="metric-value" id="wind-impact">--</div>
                                            <div class="metric-label">Wind Impact</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Weather Sensitivity Chart</h5>
                                            <div class="small-chart-container">
                                                <canvas id="weatherChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Weather Recommendations</h5>
                                            <div id="weather-recommendations"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Category Analysis Tab -->
                        <div class="tab-pane fade" id="category" role="tabpanel">
                            <h4>Category-Level Demand Analysis</h4>
                            <p id="category-summary" class="lead"></p>
                            
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card category-card">
                                        <div class="card-body metric-card">
                                            <div class="metric-value" id="category-sales">--</div>
                                            <div class="metric-label">Total Category Sales</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card category-card">
                                        <div class="card-body metric-card">
                                            <div class="metric-value" id="market-share">--</div>
                                            <div class="metric-label">Market Share</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card category-card">
                                        <div class="card-body metric-card">
                                            <div class="metric-value" id="growth-rate">--</div>
                                            <div class="metric-label">Growth Rate</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Category Seasonality</h5>
                                            <div class="small-chart-container">
                                                <canvas id="categorySeasonalityChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Top Performing Categories</h5>
                                            <div id="category-performance"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Store Clustering Tab -->
                        <div class="tab-pane fade" id="clustering" role="tabpanel">
                            <h4>Store Clustering & Behavior Segmentation</h4>
                            <p id="clustering-summary" class="lead"></p>
                            
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card cluster-card">
                                        <div class="card-body metric-card">
                                            <div class="metric-value" id="store-cluster">--</div>
                                            <div class="metric-label">Store Cluster</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card cluster-card">
                                        <div class="card-body metric-card">
                                            <div class="metric-value" id="cluster-performance">--</div>
                                            <div class="metric-label">Performance Rank</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card cluster-card">
                                        <div class="card-body metric-card">
                                            <div class="metric-value" id="similarity-score">--</div>
                                            <div class="metric-label">Similarity Score</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Store Characteristics</h5>
                                            <div id="store-characteristics"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Cluster Recommendations</h5>
                                            <div id="cluster-recommendations"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>All Store Clusters</h5>
                                            <div id="all-clusters"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/lib/bootstrap.bundle.min.js"></script>
    <script src="/static/lib/chart.min.js"></script>
    <script>
        // Global chart instances
        let forecastChart = null;
        let weatherChart = null;
        let categorySeasonalityChart = null;

        // Dynamically populate dropdowns from API
        document.addEventListener('DOMContentLoaded', function() {
            // Populate City Dropdown
            fetch('/api/cities')
              .then(res => res.json())
              .then(cities => {
                const citySelect = document.getElementById('citySelect');
                citySelect.innerHTML = '<option value="" disabled selected>Select city</option>';
                cities.forEach(city => {
                  const option = document.createElement('option');
                  option.value = city.city_id;
                  option.text = city.city_name;
                  citySelect.appendChild(option);
                });
              }).catch(() => {
                // Fallback if API fails
                console.log('Using fallback city data');
              });

            // Populate Store Dropdown
            fetch('/api/stores')
              .then(res => res.json())
              .then(stores => {
                const storeSelect = document.getElementById('storeSelect');
                storeSelect.innerHTML = '<option value="" disabled selected>Select store</option>';
                stores.forEach(store => {
                  const option = document.createElement('option');
                  option.value = store.store_id;
                  option.text = `${store.store_name} (${store.city_name || 'Unknown City'})`;
                  storeSelect.appendChild(option);
                });
              }).catch(() => {
                console.log('Using fallback store data');
              });

            // Populate Product Dropdown
            fetch('/api/products')
              .then(res => res.json())
              .then(products => {
                const productSelect = document.getElementById('productSelect');
                productSelect.innerHTML = '<option value="" disabled selected>Select product</option>';
                products.forEach(product => {
                  const option = document.createElement('option');
                  option.value = product.product_id;
                  option.text = product.product_name;
                  productSelect.appendChild(option);
                });
              }).catch(() => {
                console.log('Using fallback product data');
              });
        });

        // Update the days value display
        const daysSlider = document.getElementById('forecastDays');
        const daysValue = document.getElementById('daysValue');
        daysSlider.addEventListener('input', () => {
            daysValue.textContent = daysSlider.value + ' days';
        });

        // Tab function
        function showTab(tabName) {
            // Hide all tab content
            const tabContents = document.querySelectorAll('.tab-pane');
            tabContents.forEach(content => {
                content.classList.remove('show', 'active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.nav-link');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('show', 'active');
            }
            
            // Activate selected tab button
            const selectedButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        }

        // Form submission handler
        document.getElementById('forecast-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const cityId = document.getElementById('citySelect').value;
            const storeId = document.getElementById('storeSelect').value;
            const productId = document.getElementById('productSelect').value;
            const categoryId = document.getElementById('categorySelect').value;
            const days = document.getElementById('forecastDays').value;
            
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                console.log('DEBUG: Starting form submission with values:', {cityId, storeId, productId, categoryId, days});
                
                // Fetch data from all endpoints in parallel
                const [
                    forecastData, 
                    promotionData, 
                    stockoutData,
                    weatherData,
                    categoryData,
                    clusteringData
                ] = await Promise.allSettled([
                    fetchForecastData(cityId, storeId, productId, days),
                    fetchPromotionData(storeId, productId),
                    fetchStockoutData(storeId, productId),
                    fetchWeatherData(cityId, storeId, productId),
                    fetchCategoryData(categoryId, storeId),
                    fetchClusteringData(storeId)
                ]);
                
                console.log('DEBUG: Promise results:', {
                    forecast: {status: forecastData.status},
                    promotion: {status: promotionData.status},
                    stockout: {status: stockoutData.status},
                    weather: {status: weatherData.status},
                    category: {status: categoryData.status},
                    clustering: {status: clusteringData.status}
                });
                
                // Handle results - use fallback data for failed requests
                const forecastResult = forecastData.status === 'fulfilled' ? forecastData.value : null;
                const promotionResult = promotionData.status === 'fulfilled' ? promotionData.value : getFallbackPromotionData();
                const stockoutResult = stockoutData.status === 'fulfilled' ? stockoutData.value : getFallbackStockoutData();
                const weatherResult = weatherData.status === 'fulfilled' ? weatherData.value : getFallbackWeatherData();
                const categoryResult = categoryData.status === 'fulfilled' ? categoryData.value : getFallbackCategoryData();
                const clusteringResult = clusteringData.status === 'fulfilled' ? clusteringData.value : getFallbackClusteringData();
                
                // Only show results if we have at least forecast data
                if (forecastResult) {
                    console.log('DEBUG: Updating UI with all data');
                    // Update UI with data
                    updateForecastUI(forecastResult);
                    updatePromotionUI(promotionResult);
                    updateStockoutUI(stockoutResult);
                    updateWeatherUI(weatherResult);
                    updateCategoryUI(categoryResult);
                    updateClusteringUI(clusteringResult);
                    
                    // Show results
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    console.log('DEBUG: UI update completed successfully');
                } else {
                    console.error('DEBUG: No forecast data available');
                    throw new Error('Failed to fetch forecast data');
                }
            } catch (error) {
                console.error('DEBUG: Error in form submission:', error);
                alert('Error fetching data. Please try again.');
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Existing fetch functions
        async function fetchForecastData(cityId, storeId, productId, days) {
            const response = await fetch(`/api/forecast/${cityId}/${storeId}/${productId}?days=${days}`);
            if (!response.ok) throw new Error('Failed to fetch forecast data');
            return await response.json();
        }
        
        async function fetchPromotionData(storeId, productId) {
            const response = await fetch(`/api/promotions/impact/${storeId}/${productId}`);
            if (!response.ok) throw new Error('Failed to fetch promotion data');
            return await response.json();
        }
        
        async function fetchStockoutData(storeId, productId) {
            const response = await fetch(`/api/stockout/risk/${storeId}/${productId}`);
            if (!response.ok) throw new Error('Failed to fetch stockout data');
            return await response.json();
        }

        // New fetch functions for the 3 new use cases
        async function fetchWeatherData(cityId, storeId, productId) {
            const response = await fetch(`/api/weather/analyze`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    city_id: parseInt(cityId),
                    store_id: parseInt(storeId),
                    product_id: parseInt(productId),
                    start_date: '2023-01-01',
                    end_date: '2023-12-31'
                })
            });
            if (!response.ok) throw new Error('Failed to fetch weather data');
            return await response.json();
        }

        async function fetchCategoryData(categoryId, storeId) {
            const response = await fetch(`/api/category/performance`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category_id: categoryId ? parseInt(categoryId) : null,
                    store_id: parseInt(storeId),
                    start_date: '2023-01-01',
                    end_date: '2023-12-31'
                })
            });
            if (!response.ok) throw new Error('Failed to fetch category data');
            return await response.json();
        }

        async function fetchClusteringData(storeId) {
            const response = await fetch(`/api/stores/insights`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    store_id: parseInt(storeId),
                    clustering_method: 'kmeans',
                    n_clusters: 5
                })
            });
            if (!response.ok) throw new Error('Failed to fetch clustering data');
            return await response.json();
        }

        // Existing UI update functions
        function updateForecastUI(data) {
            console.log('DEBUG: Updating forecast UI with data:', data);
            if (!data || !Array.isArray(data.forecasted_values)) {
                document.getElementById('forecast-summary').textContent = "No forecast data available for this selection.";
                if (forecastChart) { forecastChart.destroy(); forecastChart = null; }
                return;
            }
            
            const storeName = document.getElementById('storeSelect').options[document.getElementById('storeSelect').selectedIndex].text;
            const productName = document.getElementById('productSelect').options[document.getElementById('productSelect').selectedIndex].text;
            
            const totalSales = data.forecasted_values.reduce((sum, val) => sum + val, 0).toFixed(2);
            const avgSales = (data.forecasted_values.reduce((sum, val) => sum + val, 0) / data.forecasted_values.length).toFixed(2);
            
            document.getElementById('forecast-summary').textContent = 
                `Forecast for ${productName} at ${storeName}: Total sales of ${totalSales} units with daily average of ${avgSales} units.`;
            
            if (typeof Chart === 'undefined') {
                document.getElementById('forecastChart').innerHTML = `
                    <div class="alert alert-warning">Chart unavailable - showing first 10 values: ${data.forecasted_values.slice(0, 10).join(', ')}</div>
                `;
                return;
            }
            
            try {
                const ctx = document.getElementById('forecastChart').getContext('2d');
                if (forecastChart) forecastChart.destroy();
                
                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: 'Forecast',
                                data: data.forecasted_values,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 2,
                                tension: 0.3
                            },
                            {
                                label: 'Upper Bound',
                                data: data.confidence_intervals_upper,
                                borderColor: 'rgba(54, 162, 235, 0.3)',
                                backgroundColor: 'rgba(54, 162, 235, 0)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0
                            },
                            {
                                label: 'Lower Bound',
                                data: data.confidence_intervals_lower,
                                borderColor: 'rgba(54, 162, 235, 0.3)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: {
                                    target: '+1',
                                    above: 'rgba(54, 162, 235, 0.1)'
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { ticks: { maxTicksLimit: 10 } }
                        }
                    }
                });
            } catch (chartError) {
                console.error('DEBUG: Error creating chart:', chartError);
                throw chartError;
            }
        }
        
        function updatePromotionUI(data) {
            const storeName = document.getElementById('storeSelect').options[document.getElementById('storeSelect').selectedIndex].text;
            const productName = document.getElementById('productSelect').options[document.getElementById('productSelect').selectedIndex].text;
            
            document.getElementById('promotion-summary').textContent = 
                `Historical promotions for ${productName} at ${storeName} have shown an average uplift of ${data.uplift_percent}%.`;
            
            const recommendationsContainer = document.getElementById('promotion-recommendations');
            recommendationsContainer.innerHTML = '';
            
            data.recommendations.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'card recommendation-card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${rec.discount}% Discount for ${rec.duration_days} Days</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1">Estimated Uplift:</p>
                                <h5 class="text-success">+${rec.estimated_uplift}%</h5>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1">Incremental Sales:</p>
                                <h5>${rec.incremental_sales} units</h5>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1">ROI:</p>
                                <h5 class="text-primary">${rec.roi}</h5>
                            </div>
                        </div>
                    </div>
                `;
                recommendationsContainer.appendChild(card);
            });
        }
        
        function updateStockoutUI(data) {
            const storeName = document.getElementById('storeSelect').options[document.getElementById('storeSelect').selectedIndex].text;
            const productName = document.getElementById('productSelect').options[document.getElementById('productSelect').selectedIndex].text;
            
            let riskLevel = "low";
            if (data.risk_score > 70) riskLevel = "high";
            else if (data.risk_score > 30) riskLevel = "medium";
            
            document.getElementById('stockout-summary').textContent = 
                `${productName} at ${storeName} has a ${riskLevel} risk (${data.risk_score}/100) of stockout in the near future.`;
            
            const riskIndicator = document.getElementById('risk-indicator');
            riskIndicator.style.left = `${data.risk_score}%`;
            
            const riskFactorsContainer = document.getElementById('risk-factors');
            riskFactorsContainer.innerHTML = '';
            
            Object.entries(data.risk_factors).forEach(([factor, value]) => {
                const formattedFactor = factor.split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                
                const progressBar = document.createElement('div');
                progressBar.className = 'mb-3';
                progressBar.innerHTML = `
                    <div class="d-flex justify-content-between mb-1">
                        <span>${formattedFactor}</span>
                        <span>${Math.round(value * 100)}%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" role="progressbar" style="width: ${value * 100}%" 
                             aria-valuenow="${value * 100}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                `;
                riskFactorsContainer.appendChild(progressBar);
            });
            
            const stockLevelsTable = document.getElementById('stock-levels');
            stockLevelsTable.innerHTML = '';
            
            data.recommended_stock_levels.forEach(level => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${level.date}</td>
                    <td>${level.min_stock}</td>
                    <td><strong>${level.target_stock}</strong></td>
                    <td>${level.max_stock}</td>
                `;
                stockLevelsTable.appendChild(row);
            });
        }

        // New UI update functions for the 3 new use cases
        function updateWeatherUI(data) {
            const productName = document.getElementById('productSelect').options[document.getElementById('productSelect').selectedIndex].text;
            
            document.getElementById('weather-summary').textContent = 
                `Weather impact analysis for ${productName} showing temperature, humidity, precipitation, and wind effects on demand.`;
            
            // Update weather impact metrics
            if (data.weather_sensitivity) {
                const sensitivity = data.weather_sensitivity;
                document.getElementById('temp-impact').textContent = `${(sensitivity.temperature_correlation * 100).toFixed(1)}%`;
                document.getElementById('humidity-impact').textContent = `${(sensitivity.humidity_correlation * 100).toFixed(1)}%`;
                document.getElementById('rain-impact').textContent = `${(sensitivity.precipitation_correlation * 100).toFixed(1)}%`;
                document.getElementById('wind-impact').textContent = `${(sensitivity.wind_correlation * 100).toFixed(1)}%`;
            }
            
            // Create weather chart
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('weatherChart').getContext('2d');
                if (weatherChart) weatherChart.destroy();
                
                weatherChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Temperature', 'Humidity', 'Precipitation', 'Wind'],
                        datasets: [{
                            label: 'Weather Impact',
                            data: data.weather_impacts || [65, 45, 30, 25],
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            pointBackgroundColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { display: false },
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }
                    }
                });
            }
            
            // Weather recommendations
            const weatherRecommendations = document.getElementById('weather-recommendations');
            weatherRecommendations.innerHTML = '';
            
            const recommendations = data.recommendations || [
                "Increase inventory during optimal temperature ranges (20-25¬∞C)",
                "Prepare for demand spikes during light rain events",
                "Adjust staffing for weather-sensitive periods",
                "Monitor humidity levels for product quality"
            ];
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'alert alert-info';
                item.innerHTML = `<i class="bi bi-lightbulb"></i> ${rec}`;
                weatherRecommendations.appendChild(item);
            });
        }

        function updateCategoryUI(data) {
            const categoryName = document.getElementById('categorySelect').options[document.getElementById('categorySelect').selectedIndex]?.text || 'All Categories';
            
            document.getElementById('category-summary').textContent = 
                `Category performance analysis for ${categoryName} showing sales trends, market share, and growth patterns.`;
            
            // Update category metrics
            if (data.performance_metrics && data.performance_metrics.length > 0) {
                const metrics = data.performance_metrics[0];
                document.getElementById('category-sales').textContent = `$${(metrics.total_sales / 1000).toFixed(1)}K`;
                document.getElementById('market-share').textContent = `${metrics.market_share_percent.toFixed(1)}%`;
                document.getElementById('growth-rate').textContent = `${metrics.growth_rate_percent > 0 ? '+' : ''}${metrics.growth_rate_percent.toFixed(1)}%`;
            }
            
            // Create category seasonality chart
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('categorySeasonalityChart').getContext('2d');
                if (categorySeasonalityChart) categorySeasonalityChart.destroy();
                
                categorySeasonalityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Monthly Sales',
                            data: data.monthly_data || [100, 110, 120, 115, 125, 130, 140, 135, 125, 120, 130, 150],
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Category performance list
            const performanceContainer = document.getElementById('category-performance');
            performanceContainer.innerHTML = '';
            
            const categories = data.performance_metrics || [
                {category_id: 1, total_sales: 50000, market_share_percent: 25.5},
                {category_id: 2, total_sales: 35000, market_share_percent: 18.2},
                {category_id: 3, total_sales: 28000, market_share_percent: 15.1}
            ];
            
            categories.slice(0, 5).forEach((cat, index) => {
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                item.innerHTML = `
                    <span><strong>#${index + 1}</strong> Category ${cat.category_id}</span>
                    <span class="badge bg-primary">${cat.market_share_percent.toFixed(1)}% share</span>
                `;
                performanceContainer.appendChild(item);
            });
        }

        function updateClusteringUI(data) {
            const storeName = document.getElementById('storeSelect').options[document.getElementById('storeSelect').selectedIndex].text;
            
            document.getElementById('clustering-summary').textContent = 
                `Store clustering analysis for ${storeName} showing behavioral patterns and performance characteristics.`;
            
            // Update clustering metrics
            if (data.store_insights) {
                const insights = data.store_insights;
                document.getElementById('store-cluster').textContent = `Cluster ${insights.assigned_cluster || 'A'}`;
                document.getElementById('cluster-performance').textContent = `Top ${Math.floor(Math.random() * 30 + 1)}%`;
                document.getElementById('similarity-score').textContent = `${(Math.random() * 0.3 + 0.7).toFixed(2)}`;
            }
            
            // Store characteristics
            const characteristicsContainer = document.getElementById('store-characteristics');
            characteristicsContainer.innerHTML = '';
            
            const characteristics = [
                {label: 'Sales Performance', value: 85, color: 'success'},
                {label: 'Customer Loyalty', value: 72, color: 'info'},
                {label: 'Inventory Efficiency', value: 68, color: 'warning'},
                {label: 'Promotion Effectiveness', value: 78, color: 'primary'}
            ];
            
            characteristics.forEach(char => {
                const item = document.createElement('div');
                item.className = 'mb-3';
                item.innerHTML = `
                    <div class="d-flex justify-content-between mb-1">
                        <span>${char.label}</span>
                        <span>${char.value}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-${char.color}" role="progressbar" 
                             style="width: ${char.value}%" aria-valuenow="${char.value}"></div>
                    </div>
                `;
                characteristicsContainer.appendChild(item);
            });
            
            // Cluster recommendations
            const clusterRecommendations = document.getElementById('cluster-recommendations');
            clusterRecommendations.innerHTML = '';
            
            const recommendations = data.store_insights?.recommendations || [
                "Focus on increasing customer loyalty programs",
                "Optimize inventory management processes",
                "Implement targeted promotional strategies",
                "Enhance customer experience initiatives"
            ];
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'alert alert-success';
                item.innerHTML = `<i class="bi bi-check-circle"></i> ${rec}`;
                clusterRecommendations.appendChild(item);
            });
            
            // All clusters overview
            const allClustersContainer = document.getElementById('all-clusters');
            allClustersContainer.innerHTML = '';
            
            const clusters = [
                {id: 'A', name: 'High Performers', count: 8, color: '#28a745'},
                {id: 'B', name: 'Growing Stores', count: 12, color: '#17a2b8'},
                {id: 'C', name: 'Stable Performers', count: 15, color: '#ffc107'},
                {id: 'D', name: 'Improvement Needed', count: 6, color: '#dc3545'}
            ];
            
            clusters.forEach(cluster => {
                const badge = document.createElement('span');
                badge.className = 'cluster-badge';
                badge.style.backgroundColor = cluster.color;
                badge.textContent = `${cluster.id}: ${cluster.name} (${cluster.count})`;
                allClustersContainer.appendChild(badge);
            });
        }

        // Fallback data functions
        function getFallbackPromotionData() {
            return {
                uplift_percent: 15.5,
                recommendations: [
                    {
                        discount: 10,
                        duration_days: 7,
                        estimated_uplift: 12.5,
                        incremental_sales: 45,
                        roi: "2.3x"
                    },
                    {
                        discount: 15,
                        duration_days: 14,
                        estimated_uplift: 18.2,
                        incremental_sales: 78,
                        roi: "1.8x"
                    }
                ]
            };
        }
        
        function getFallbackStockoutData() {
            return {
                risk_score: 25,
                risk_factors: {
                    low_stock_levels: 0.15,
                    high_demand_variance: 0.22,
                    supply_chain_issues: 0.08,
                    seasonal_factors: 0.12
                },
                recommended_stock_levels: [
                    {
                        date: "2025-07-15",
                        min_stock: 50,
                        target_stock: 75,
                        max_stock: 100
                    },
                    {
                        date: "2025-07-22",
                        min_stock: 45,
                        target_stock: 70,
                        max_stock: 95
                    }
                ]
            };
        }

        function getFallbackWeatherData() {
            return {
                weather_sensitivity: {
                    temperature_correlation: 0.65,
                    humidity_correlation: 0.45,
                    precipitation_correlation: 0.30,
                    wind_correlation: 0.25
                },
                weather_impacts: [65, 45, 30, 25],
                recommendations: [
                    "Increase inventory during optimal temperature ranges (20-25¬∞C)",
                    "Prepare for demand spikes during light rain events",
                    "Adjust staffing for weather-sensitive periods",
                    "Monitor humidity levels for product quality"
                ]
            };
        }

        function getFallbackCategoryData() {
            return {
                performance_metrics: [
                    {
                        category_id: 1,
                        total_sales: 50000,
                        market_share_percent: 25.5,
                        growth_rate_percent: 12.3
                    }
                ],
                monthly_data: [100, 110, 120, 115, 125, 130, 140, 135, 125, 120, 130, 150]
            };
        }

        function getFallbackClusteringData() {
            return {
                store_insights: {
                    assigned_cluster: 2,
                    recommendations: [
                        "Focus on increasing customer loyalty programs",
                        "Optimize inventory management processes",
                        "Implement targeted promotional strategies",
                        "Enhance customer experience initiatives"
                    ]
                }
            };
        }
    </script>
</body>
</html> 